{% extends "base.html" %}

{% block extra_css %}
<style>
.calendar-container {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.calendar-header {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.week-view {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
}

.week-day {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
}

.week-day-header {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
    color: #495057;
}

.week-day-events {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.teacher-group {
    margin-bottom: 1rem;
}

.teacher-name {
    font-weight: bold;
    color: #6c757d;
    margin-bottom: 0.5rem;
    padding-left: 0.5rem;
    border-left: 3px solid #007bff;
}

.calendar-event {
    background-color: #007bff;
    color: white;
    padding: 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.85rem;
    cursor: pointer;
    margin-bottom: 0.25rem;
    transition: background-color 0.2s;
}

.calendar-event:hover {
    background-color: #0056b3;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    üóìÔ∏è Planning Hebdomadaire - Demandes de Mat√©riel
                </h4>
                <div>
                    <button class="btn btn-light btn-sm me-2" onclick="loadCalendar()">
                        üîÑ Actualiser
                    </button>
                    <a href="/requests" class="btn btn-light btn-sm">
                        üìã Liste des demandes
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="calendarFilterTeacher" class="form-label">üë®‚Äçüè´ Enseignant</label>
                        <select class="form-select" id="calendarFilterTeacher">
                            <option value="">Tous les enseignants</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="calendarFilterStatus" class="form-label">üìä Statut</label>
                        <select class="form-select" id="calendarFilterStatus">
                            <option value="">Tous</option>
                            <option value="prepared">Pr√©par√©es</option>
                            <option value="modified">Modifi√©es</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="calendarFilterType" class="form-label">üìù Type</label>
                        <select class="form-select" id="calendarFilterType">
                            <option value="">Tous</option>
                            <option value="normal">Demandes normales</option>
                            <option value="absent">Absences</option>
                            <option value="no-material">Pas besoin de mat√©riel</option>
                        </select>
                    </div>
                </div>
                
                <!-- Vue semaine -->
                <div class="row">
                    <div class="col-12">
                        <div class="week-calendar">
                            <div class="calendar-header text-center mb-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="previousWeek()">‚Äπ Semaine pr√©c√©dente</button>
                                <h5 id="currentWeek" class="d-inline mx-4 mb-0"></h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="nextWeek()">Semaine suivante ‚Ä∫</button>
                            </div>
                            <div class="week-view" id="weekView">
                                <!-- Week view will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    üìù D√©tails de la demande
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="eventDetails">
                    <!-- Event details will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentWeekStart = getStartOfWeek(new Date());
let events = [];

function getStartOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
    return new Date(d.setDate(diff));
}

function getWeekDays(startDate) {
    const days = [];
    for (let i = 0; i < 5; i++) { // Only Monday to Friday
        const day = new Date(startDate);
        day.setDate(startDate.getDate() + i);
        days.push(day);
    }
    return days;
}

// Gestion des cookies
function setCookie(name, value, days = 30) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
}

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

document.addEventListener('DOMContentLoaded', function() {
    // Load teachers for filter
    fetch('/api/teachers')
        .then(response => response.json())
        .then(teachers => {
            const teacherFilter = document.getElementById('calendarFilterTeacher');
            teacherFilter.innerHTML = '<option value="">Tous les enseignants</option>';
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                teacherFilter.appendChild(option);
            });
            
            // Restore selected teacher from cookie
            const savedTeacher = getCookie('selectedTeacher');
            if (savedTeacher) {
                teacherFilter.value = savedTeacher;
            }
        });
    
    // Set up filter change handlers
    document.getElementById('calendarFilterTeacher').addEventListener('change', loadCalendar);
    document.getElementById('calendarFilterStatus').addEventListener('change', loadCalendar);
    document.getElementById('calendarFilterType').addEventListener('change', loadCalendar);
    
    // Save teacher selection to cookie
    document.getElementById('calendarFilterTeacher').addEventListener('change', function() {
        if (this.value) {
            setCookie('selectedTeacher', this.value);
        }
    });
    
    loadCalendar();
});

function loadCalendar() {
    // Get filter values
    const teacherId = document.getElementById('calendarFilterTeacher').value;
    const statusFilter = document.getElementById('calendarFilterStatus').value;
    const typeFilter = document.getElementById('calendarFilterType').value;
    
    // Build query string
    const params = new URLSearchParams();
    if (teacherId) params.append('teacher_id', teacherId);
    if (statusFilter) params.append('status', statusFilter);
    if (typeFilter) params.append('type', typeFilter);
    
    // Load events from API with filters
    fetch(`/api/calendar-events?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            events = data;
            renderWeekView();
        })
        .catch(error => {
            console.error('Error loading events:', error);
        });
}

function renderWeekView() {
    const weekDays = getWeekDays(currentWeekStart);
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 4); // Friday
    
    // Update week header
    const monthNames = [
        'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
    ];
    
    const startStr = `${currentWeekStart.getDate()} ${monthNames[currentWeekStart.getMonth()]}`;
    const endStr = `${weekEnd.getDate()} ${monthNames[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;
    document.getElementById('currentWeek').textContent = `Semaine du ${startStr} au ${endStr}`;
    
    // Generate week view
    const weekView = document.getElementById('weekView');
    weekView.innerHTML = '';
    
    const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
    const teacherId = document.getElementById('calendarFilterTeacher').value;
    
    weekDays.forEach((day, index) => {
        const dayElement = document.createElement('div');
        dayElement.className = 'week-day';
        
        // Day header
        const dayHeader = document.createElement('div');
        dayHeader.className = 'week-day-header';
        dayHeader.textContent = `${dayNames[index]} ${day.getDate()}/${day.getMonth() + 1}`;
        dayElement.appendChild(dayHeader);
        
        // Day events container
        const dayEventsContainer = document.createElement('div');
        dayEventsContainer.className = 'week-day-events';
        
        // Get events for this day
        const dayDate = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}-${String(day.getDate()).padStart(2, '0')}`;
        const dayEvents = events.filter(event => event.start === dayDate);
        
        if (dayEvents.length === 0) {
            const noEvents = document.createElement('div');
            noEvents.className = 'text-muted text-center py-3';
            noEvents.textContent = 'Aucune demande';
            dayEventsContainer.appendChild(noEvents);
        } else {
            // Group events by teacher if all teachers are shown
            if (!teacherId) {
                const eventsByTeacher = {};
                dayEvents.forEach(event => {
                    const teacherName = event.title.split(' - ')[0];
                    if (!eventsByTeacher[teacherName]) {
                        eventsByTeacher[teacherName] = [];
                    }
                    eventsByTeacher[teacherName].push(event);
                });
                
                Object.keys(eventsByTeacher).forEach(teacherName => {
                    const teacherGroup = document.createElement('div');
                    teacherGroup.className = 'teacher-group';
                    
                    const teacherHeader = document.createElement('div');
                    teacherHeader.className = 'teacher-name';
                    teacherHeader.textContent = teacherName;
                    teacherGroup.appendChild(teacherHeader);
                    
                    eventsByTeacher[teacherName].forEach(event => {
                        const eventElement = createEventElement(event);
                        teacherGroup.appendChild(eventElement);
                    });
                    
                    dayEventsContainer.appendChild(teacherGroup);
                });
            } else {
                // Show all events for selected teacher
                dayEvents.forEach(event => {
                    const eventElement = createEventElement(event);
                    dayEventsContainer.appendChild(eventElement);
                });
            }
        }
        
        dayElement.appendChild(dayEventsContainer);
        weekView.appendChild(dayElement);
    });
}

function createEventElement(event) {
    const eventElement = document.createElement('div');
    eventElement.className = 'calendar-event';
    eventElement.style.backgroundColor = event.backgroundColor || '#007bff';
    
    const className = event.title.split(' - ')[1] || '';
    eventElement.innerHTML = `
        <div><strong>${className}</strong></div>
        <div class="small">${event.description.replace('Mat√©riel: ', '')}</div>
    `;
    
    eventElement.onclick = () => showEventDetails(event);
    return eventElement;
}

function previousWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderWeekView();
}

function nextWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderWeekView();
}

function showEventDetails(event) {
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    const details = document.getElementById('eventDetails');
    
    details.innerHTML = `
        <div class="row">
            <div class="col-sm-4"><strong>Enseignant:</strong></div>
            <div class="col-sm-8">${event.title.split(' - ')[0]}</div>
        </div>
        <div class="row mt-2">
            <div class="col-sm-4"><strong>Classe:</strong></div>
            <div class="col-sm-8">${event.title.split(' - ')[1]}</div>
        </div>
        <div class="row mt-2">
            <div class="col-sm-4"><strong>Date:</strong></div>
            <div class="col-sm-8">${formatDate(event.start)}</div>
        </div>
        <div class="row mt-2">
            <div class="col-sm-4"><strong>Description:</strong></div>
            <div class="col-sm-8">${event.description}</div>
        </div>
    `;
    
    modal.show();
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// Toast functions 
function showSuccessToast(message) {
    if (typeof window.showToast === 'function') {
        window.showToast('success', 'Succ√®s', message);
    } else {
        alert(message);
    }
}

function showErrorToast(message) {
    if (typeof window.showToast === 'function') {
        window.showToast('error', 'Erreur', message);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}