{% extends "base.html" %}

{% block title %}Toutes les Demandes - Demande de MatÃ©riel{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-0">
                            ğŸ“‹ Toutes les Demandes de MatÃ©riel
                        </h4>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-light btn-sm me-2" onclick="loadRequests()">
                            ğŸ”„ Actualiser
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportRequests()">
                            ğŸ“¥ Export CSV
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="filterTeacher" class="form-label">Filtrer par enseignant:</label>
                        <select class="form-select" id="filterTeacher" onchange="loadRequests()">
                            <option value="">Tous les enseignants</option>
                            {% for teacher in teachers %}
                            <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterStartDate" class="form-label">Date de dÃ©but:</label>
                        <input type="date" class="form-control" id="filterStartDate" onchange="loadRequests()">
                    </div>
                    <div class="col-md-3">
                        <label for="filterEndDate" class="form-label">Date de fin:</label>
                        <input type="date" class="form-control" id="filterEndDate" onchange="loadRequests()">
                    </div>
                    <div class="col-md-3">
                        <label for="filterStatus" class="form-label">Statut:</label>
                        <select class="form-select" id="filterStatus" onchange="loadRequests()">
                            <option value="">Tous</option>
                            <option value="prepared">PrÃ©parÃ©es</option>
                            <option value="not-prepared">Non prÃ©parÃ©es</option>
                            <option value="modified">ModifiÃ©es</option>
                        </select>
                    </div>
                </div>
                
                <!-- View Mode Toggle -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="groupByRequestName" onchange="toggleViewMode()">
                            <label class="form-check-label fw-bold" for="groupByRequestName">
                                ğŸ·ï¸ Grouper par nom de demande (voir tous les horaires d'une mÃªme demande)
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Loading indicator -->
                <div id="loadingIndicator" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="requestsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Enseignant</th>
                                <th>ğŸ·ï¸ Nom de demande</th>
                                <th>ğŸ“… Date</th>
                                <th>â° Horaire</th>
                                <th>ğŸ“ Niveau</th>
                                <th>ğŸ‘¥ Groupes</th>
                                <th>ğŸ’» Ordinateurs</th>
                                <th>ğŸ“‹ Description</th>
                                <th>ğŸ”¬ MatÃ©riel Prof</th>
                                <th>ğŸ“ Notes</th>
                                <th>ğŸ“Š Statut</th>
                                <th>âš™ï¸ Actions</th>
                                <th>ğŸ“… CrÃ©Ã© le</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <!-- Requests will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- No results message -->
                <div id="noResults" class="text-center text-muted d-none">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Aucune demande trouvÃ©e avec les filtres sÃ©lectionnÃ©s.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Request Modal -->
<div class="modal fade" id="editRequestModal" tabindex="-1" aria-labelledby="editRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRequestModalLabel">âœï¸ Modifier la Demande</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRequestForm">
                    <input type="hidden" id="editRequestId">
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="editTeacher" class="form-label">ğŸ‘¨â€ğŸ« Enseignant *</label>
                            <select class="form-select" id="editTeacher" required>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="editRequestName" class="form-label">ğŸ·ï¸ Nom de la demande</label>
                            <input type="text" class="form-control" id="editRequestName" placeholder="Ex: TP Distillation, ContrÃ´le Atomes...">
                            <div class="form-text">Optionnel - Pour regrouper les demandes similaires</div>
                        </div>
                        <div class="col-md-4">
                            <label for="editDate" class="form-label">ğŸ“… Date *</label>
                            <input type="date" class="form-control" id="editDate" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editHoraire" class="form-label">â° Horaire</label>
                            <select class="form-select" id="editHoraire">
                                <option value="">SÃ©lectionner un horaire</option>
                                <optgroup label="ğŸŒ… Matin">
                                    <option value="9h00">9h00</option>
                                    <option value="9h30">9h30</option>
                                    <option value="10h00">10h00</option>
                                    <option value="10h45">10h45</option>
                                    <option value="11h15">11h15</option>
                                    <option value="11h45">11h45</option>
                                    <option value="12h15">12h15</option>
                                    <option value="12h45">12h45</option>
                                </optgroup>
                                <optgroup label="ğŸŒ‡ AprÃ¨s-midi">
                                    <option value="13h15">13h15</option>
                                    <option value="13h45">13h45</option>
                                    <option value="14h15">14h15</option>
                                    <option value="14h45">14h45</option>
                                    <option value="15h15">15h15</option>
                                    <option value="15h45">15h45</option>
                                    <option value="16h15">16h15</option>
                                    <option value="16h45">16h45</option>
                                    <option value="17h15">17h15</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editClassName" class="form-label">ğŸ“ Niveau/Classe *</label>
                            <select class="form-select" id="editClassName" required>
                                <option value="">SÃ©lectionner un niveau</option>
                                <option value="6Ã¨me">6Ã¨me</option>
                                <option value="5Ã¨me">5Ã¨me</option>
                                <option value="4Ã¨me">4Ã¨me</option>
                                <option value="3Ã¨me">3Ã¨me</option>
                                <option value="SNT">SNT</option>
                                <option value="SI">SI</option>
                                <option value="2nd Classe">2nd Classe</option>
                                <option value="2nd TP">2nd TP</option>
                                <option value="AP PP">AP PP</option>
                                <option value="AP 2nd">AP 2nd</option>
                                <option value="1Ã¨re ES">1Ã¨re ES</option>
                                <option value="Terminale ES">Terminale ES</option>
                                <option value="1Ã¨re SpÃ©cialitÃ©">1Ã¨re SpÃ©cialitÃ©</option>
                                <option value="Terminale SpÃ©cialitÃ©">Terminale SpÃ©cialitÃ©</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Cases Absent, Pas besoin de matÃ©riel et Examen dans le modal -->
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editAbsent" name="editAbsent">
                                    <label class="form-check-label fw-bold" for="editAbsent">
                                        âŒ Absent (cocher si enseignant absent ce jour-lÃ )
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editNoMaterial" name="editNoMaterial">
                                    <label class="form-check-label fw-bold" for="editNoMaterial">
                                        ğŸ“š Pas besoin de matÃ©riel (cours thÃ©orique)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editExamMode" name="editExamMode">
                                    <label class="form-check-label fw-bold" for="editExamMode">
                                        ğŸ“ Examen (surveillance d'examen)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">Si absent, pas besoin de matÃ©riel, ou examen, seule la sÃ©lection du niveau sera nÃ©cessaire.</small>
                    </div>
                    
                    <!-- Nombre de groupes et ordinateurs d'abord -->
                    <div class="row mb-3" id="editQuantitySection">
                        <div class="col-md-4">
                            <label for="editQuantity" class="form-label">ğŸ”¢ Nombre de groupes</label>
                            <input type="number" class="form-control" id="editQuantity" min="1" value="1">
                        </div>
                        <div class="col-md-4">
                            <label for="editComputersNeeded" class="form-label">ğŸ’» Nombre d'ordinateurs</label>
                            <input type="number" class="form-control" id="editComputersNeeded" min="0" value="0">
                        </div>
                    </div>
                    
                    <!-- Material description ensuite -->
                    <div class="mb-3" id="editMaterialSection">
                        <label for="editMaterialDescription" class="form-label">
                            ğŸ“ MatÃ©riel requis par groupe
                        </label>
                        <textarea class="form-control" id="editMaterialDescription" rows="4" 
                                  placeholder="Ex: 2 Tubes Ã  essai, 1 verre de montre, 1 bÃ©cher 100mL, pipettes graduÃ©es..."></textarea>
                    </div>
                    
                    <div class="mb-3" id="editMaterialProfSection">
                        <label for="editMaterialProf" class="form-label">ğŸ‘¨â€ğŸ« MatÃ©riel Prof</label>
                        <textarea class="form-control" id="editMaterialProf" rows="2" 
                                  placeholder="MatÃ©riel nÃ©cessaire pour le professeur"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">ğŸ“ Notes supplÃ©mentaires</label>
                        <textarea class="form-control" id="editNotes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" onclick="deleteRequest()" title="Supprimer dÃ©finitivement cette demande">
                    ğŸ—‘ï¸ Supprimer
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveRequestChanges()">ğŸ’¾ Sauvegarder</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Gestion des cookies
function setCookie(name, value, days = 30) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
}

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

function initializeFilters() {
    // DÃ©finir automatiquement la date de dÃ©but Ã  aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('filterStartDate').value = today;
    
    // Restaurer l'enseignant depuis le cookie
    const savedTeacher = getCookie('selectedTeacher');
    if (savedTeacher) {
        const teacherSelect = document.getElementById('filterTeacher');
        teacherSelect.value = savedTeacher;
        console.log(`ğŸª Enseignant restaurÃ© depuis le cookie: ${savedTeacher}`);
    }
    
    console.log(`ğŸ“… Date par dÃ©faut dÃ©finie: ${today}`);
}

document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    loadRequests();
});

function loadRequests() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const tableBody = document.getElementById('requestsTableBody');
    const noResults = document.getElementById('noResults');
    
    // Show loading
    loadingIndicator.classList.remove('d-none');
    tableBody.innerHTML = '';
    noResults.classList.add('d-none');
    
    // Get filter values
    const teacherId = document.getElementById('filterTeacher').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    // Sauvegarder l'enseignant sÃ©lectionnÃ© dans un cookie
    if (teacherId) {
        setCookie('selectedTeacher', teacherId);
        console.log(`ğŸª Enseignant sauvegardÃ© dans le cookie: ${teacherId}`);
    }
    
    // Build query string
    const params = new URLSearchParams();
    if (teacherId) params.append('teacher_id', teacherId);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    // Fetch requests
    fetch(`/api/requests?${params.toString()}`)
        .then(response => response.json())
        .then(requests => {
            loadingIndicator.classList.add('d-none');
            
            if (requests.length === 0) {
                noResults.classList.remove('d-none');
                return;
            }
            
            // Filter by status if needed
            let filteredRequests = requests;
            if (statusFilter) {
                filteredRequests = requests.filter(request => {
                    switch(statusFilter) {
                        case 'prepared': return request.prepared === true;
                        case 'not-prepared': return request.prepared === false || !request.prepared;
                        case 'modified': return request.modified === true;
                        default: return true;
                    }
                });
            }
            
            // Populate table
            filteredRequests.forEach(request => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.addEventListener('dblclick', () => editRequest(request.id));
                
                const statusBadge = getStatusBadge(request);
                const preparedButton = getPreparedButton(request);
                
                row.innerHTML = `
                    <td>${request.id}</td>
                    <td><div class="fw-bold">${request.teacher_name || '<em class="text-muted">Nom manquant</em>'}</div></td>
                    <td><span class="badge bg-primary">${request.request_name || '<em class="text-muted">Sans nom</em>'}</span></td>
                    <td>${formatDate(request.request_date)}</td>
                    <td><span class="badge bg-success">${request.horaire || '-'}</span></td>
                    <td><span class="badge bg-info">${request.class_name}</span></td>
                    <td><span class="badge bg-secondary">${request.group_count || request.quantity || 1}</span></td>
                    <td><span class="badge bg-warning">${request.computers_needed || 0}</span></td>
                    <td>${request.material_description}</td>
                    <td><small class="text-muted" style="white-space: pre-wrap;">${request.material_prof || '<em>Aucun</em>'}</small></td>
                    <td style="white-space: pre-wrap;">${request.notes || '<em class="text-muted">Aucune</em>'}</td>
                    <td>${statusBadge}</td>
                    <td>${preparedButton}</td>
                    <td><small class="text-muted">${formatDateTime(request.created_at)}</small></td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            loadingIndicator.classList.add('d-none');
            showErrorToast('Erreur lors du chargement des demandes');
        });
}

function exportRequests() {
    // Get filter values
    const teacherId = document.getElementById('filterTeacher').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    
    // Build query string
    const params = new URLSearchParams();
    if (teacherId) params.append('teacher_id', teacherId);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    // Open export URL
    window.open(`/export/csv?${params.toString()}`, '_blank');
    showSuccessToast('Export CSV en cours...');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${day}/${month}/${year} ${hours}:${minutes}`;
}

function getStatusBadge(request) {
    let badges = [];
    if (request.prepared) {
        badges.push('<span class="badge bg-success">âœ… PrÃ©parÃ©e</span>');
    } else {
        badges.push('<span class="badge bg-light text-dark">â³ Non prÃ©parÃ©e</span>');
    }
    if (request.modified) {
        badges.push('<span class="badge bg-warning">âš ï¸ ModifiÃ©e</span>');
    }
    return badges.join(' ');
}

function getPreparedButton(request) {
    const buttonClass = request.prepared ? 'btn-outline-success' : 'btn-outline-secondary';
    const buttonText = request.prepared ? 'âœ… PrÃ©parÃ©e' : 'â³ Marquer prÃ©parÃ©e';
    return `<button class="btn btn-sm ${buttonClass}" onclick="togglePrepared(${request.id}); event.stopPropagation();">${buttonText}</button>`;
}

function editRequest(requestId) {
    // Fetch request details
    fetch(`/api/requests/${requestId}`)
        .then(response => response.json())
        .then(request => {
            // Check if this is a special request type
            const isAbsent = request.selected_materials === 'Absent' && request.material_description === 'Enseignant absent';
            const isNoMaterial = request.selected_materials === 'Pas besoin de matÃ©riel' && request.material_description === 'Cours thÃ©orique sans matÃ©riel';
            const isExamMode = request.selected_materials === 'Examen' && request.material_description === 'Surveillance d\'examen';
            
            // Populate form
            document.getElementById('editRequestId').value = request.id;
            document.getElementById('editTeacher').value = request.teacher_id;
            document.getElementById('editRequestName').value = request.request_name || '';
            document.getElementById('editDate').value = request.request_date;
            document.getElementById('editHoraire').value = request.horaire || '';
            document.getElementById('editClassName').value = request.class_name;
            document.getElementById('editAbsent').checked = isAbsent;
            document.getElementById('editNoMaterial').checked = isNoMaterial;
            document.getElementById('editExamMode').checked = isExamMode;
            
            document.getElementById('editQuantity').value = request.group_count || request.quantity || 1;
            document.getElementById('editComputersNeeded').value = request.computers_needed || 0;
            document.getElementById('editMaterialProf').value = request.material_prof || '';
            document.getElementById('editNotes').value = request.notes || '';
            
            // Fill material description field
            if (isAbsent || isNoMaterial || isExamMode) {
                // Pour les modes spÃ©ciaux, laisser vide
                document.getElementById('editMaterialDescription').value = '';
            } else {
                // Pour les demandes normales, extraire le matÃ©riel de material_description
                let materialContent = request.material_description || '';
                
                // Si la description commence par "MatÃ©riel requis: ", extraire seulement la partie aprÃ¨s
                if (materialContent.startsWith('MatÃ©riel requis: ')) {
                    materialContent = materialContent.substring('MatÃ©riel requis: '.length);
                }
                
                document.getElementById('editMaterialDescription').value = materialContent;
            }
            
            // Toggle sections based on special modes
            toggleEditSpecialModes();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editRequestModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorToast('Erreur lors du chargement de la demande');
        });
}

function saveRequestChanges() {
    const requestId = document.getElementById('editRequestId').value;
    const isAbsent = document.getElementById('editAbsent').checked;
    const isNoMaterial = document.getElementById('editNoMaterial').checked;
    const isExamMode = document.getElementById('editExamMode').checked;
    
    const formData = {
        teacher_id: parseInt(document.getElementById('editTeacher').value),
        request_name: document.getElementById('editRequestName').value,
        request_date: document.getElementById('editDate').value,
        horaire: document.getElementById('editHoraire').value,
        class_name: document.getElementById('editClassName').value,
        quantity: parseInt(document.getElementById('editQuantity').value) || 1,
        group_count: parseInt(document.getElementById('editQuantity').value) || 1,
        computers_needed: parseInt(document.getElementById('editComputersNeeded').value) || 0,
        material_prof: document.getElementById('editMaterialProf').value,
        notes: document.getElementById('editNotes').value
    };
    
    if (isAbsent) {
        formData.selected_materials = 'Absent';
        formData.material_description = 'Enseignant absent';
    } else if (isNoMaterial) {
        formData.selected_materials = 'Pas besoin de matÃ©riel';
        formData.material_description = 'Cours thÃ©orique sans matÃ©riel';
    } else if (isExamMode) {
        formData.selected_materials = 'Examen';
        formData.material_description = 'Surveillance d\'examen';
    } else {
        // RÃ©cupÃ©rer le contenu du champ matÃ©riel
        const materialContent = document.getElementById('editMaterialDescription').value;
        
        // Ajouter le prÃ©fixe si du matÃ©riel est spÃ©cifiÃ©
        if (materialContent && materialContent.trim()) {
            formData.material_description = `MatÃ©riel requis: ${materialContent}`;
        } else {
            formData.material_description = 'Cours sans matÃ©riel spÃ©cifique';
        }
        
        // Garder selected_materials vide pour les demandes normales
        formData.selected_materials = '';
    }
    
    fetch(`/api/requests/${requestId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        // Hide modal - Use multiple methods to ensure it closes
        const modalElement = document.getElementById('editRequestModal');
        
        // Method 1: Try to get existing modal instance
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        } else {
            // Method 2: Create new modal instance if none exists
            modal = new bootstrap.Modal(modalElement);
            modal.hide();
        }
        
        // Method 3: Fallback - remove modal classes manually
        setTimeout(() => {
            modalElement.classList.remove('show');
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }, 100);
        
        // Reload requests
        loadRequests();
        showSuccessToast('Demande modifiÃ©e avec succÃ¨s');
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Erreur lors de la modification: ' + error.message);
    });
}



function deleteRequest() {
    const requestId = document.getElementById('editRequestId').value;
    const teacherName = document.getElementById('editTeacher').selectedOptions[0].text;
    const className = document.getElementById('editClassName').value;
    const date = document.getElementById('editDate').value;
    
    // Confirmation de suppression
    const confirmMessage = `âš ï¸ ÃŠtes-vous sÃ»r de vouloir supprimer cette demande ?\n\n` +
                          `Enseignant: ${teacherName}\n` +
                          `Classe: ${className}\n` +
                          `Date: ${date}\n\n` +
                          `Cette action est irrÃ©versible !`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    fetch(`/api/requests/${requestId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Fermer le modal
        const modalElement = document.getElementById('editRequestModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
        
        // Recharger la liste des demandes
        loadRequests();
        showSuccessToast('Demande supprimÃ©e avec succÃ¨s');
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Erreur lors de la suppression: ' + error.message);
    });
}

function togglePrepared(requestId) {
    fetch(`/api/requests/${requestId}/toggle-prepared`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        loadRequests();
        showSuccessToast('Statut mis Ã  jour avec succÃ¨s');
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Erreur lors de la mise Ã  jour du statut');
    });
}

function toggleEditSpecialModes() {
    const isAbsent = document.getElementById('editAbsent').checked;
    const isNoMaterial = document.getElementById('editNoMaterial').checked;
    const isExamMode = document.getElementById('editExamMode').checked;
    const quantitySection = document.getElementById('editQuantitySection');
    const materialSection = document.getElementById('editMaterialSection');
    const materialProfSection = document.getElementById('editMaterialProfSection');
    const materialCheckboxSection = document.getElementById('editMaterialCheckboxSection');
    
    // S'assurer qu'une seule option est cochÃ©e Ã  la fois
    let checkedCount = (isAbsent ? 1 : 0) + (isNoMaterial ? 1 : 0) + (isExamMode ? 1 : 0);
    if (checkedCount > 1) {
        const activeElement = document.activeElement;
        if (activeElement === document.getElementById('editAbsent')) {
            document.getElementById('editNoMaterial').checked = false;
            document.getElementById('editExamMode').checked = false;
        } else if (activeElement === document.getElementById('editNoMaterial')) {
            document.getElementById('editAbsent').checked = false;
            document.getElementById('editExamMode').checked = false;
        } else if (activeElement === document.getElementById('editExamMode')) {
            document.getElementById('editAbsent').checked = false;
            document.getElementById('editNoMaterial').checked = false;
        }
    }
    
    const shouldHideSections = isAbsent || isNoMaterial || isExamMode;
    
    if (shouldHideSections) {
        // Hide material-related sections
        if (quantitySection) quantitySection.style.display = 'none';
        if (materialSection) materialSection.style.display = 'none';
        if (materialProfSection) materialProfSection.style.display = 'none';
        if (materialCheckboxSection) materialCheckboxSection.style.display = 'none';
        
        // Remove required attribute
        const editMaterialDescription = document.getElementById('editMaterialDescription');
        if (editMaterialDescription) editMaterialDescription.removeAttribute('required');
    } else {
        // Show material-related sections
        if (quantitySection) quantitySection.style.display = 'block';
        if (materialSection) materialSection.style.display = 'block';
        if (materialProfSection) materialProfSection.style.display = 'block';
        if (materialCheckboxSection) materialCheckboxSection.style.display = 'block';
        
        // Add required attribute back
        const editMaterialDescription = document.getElementById('editMaterialDescription');
        if (editMaterialDescription) editMaterialDescription.setAttribute('required', 'required');
    }
}

// Add event listeners when modal is first shown
document.addEventListener('DOMContentLoaded', function() {
    const editAbsentCheckbox = document.getElementById('editAbsent');
    const editNoMaterialCheckbox = document.getElementById('editNoMaterial');
    const editExamModeCheckbox = document.getElementById('editExamMode');
    if (editAbsentCheckbox) {
        editAbsentCheckbox.addEventListener('change', toggleEditSpecialModes);
    }
    if (editNoMaterialCheckbox) {
        editNoMaterialCheckbox.addEventListener('change', toggleEditSpecialModes);
    }
    if (editExamModeCheckbox) {
        editExamModeCheckbox.addEventListener('change', toggleEditSpecialModes);
    }
});

// Toast functions (using base.html toast if available)
function showSuccessToast(message) {
    if (typeof window.showToast === 'function') {
        window.showToast('success', 'SuccÃ¨s', message);
    } else {
        alert(message);
    }
}

function showErrorToast(message) {
    if (typeof window.showToast === 'function') {
        window.showToast('error', 'Erreur', message);
    } else {
        alert(message);
    }
}

// Toggle entre vue normale et vue groupÃ©e
function toggleViewMode() {
    const isGrouped = document.getElementById('groupByRequestName').checked;
    if (isGrouped) {
        loadGroupedRequests();
    } else {
        loadRequests();
    }
}

// Charger les demandes groupÃ©es par nom
function loadGroupedRequests() {
    const tableBody = document.getElementById('requestsTableBody');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const teacherId = document.getElementById('filterTeacher').value;
    
    if (!teacherId) {
        showErrorToast('Veuillez sÃ©lectionner un enseignant pour voir le groupage par nom de demande');
        document.getElementById('groupByRequestName').checked = false;
        return;
    }
    
    loadingIndicator.classList.remove('d-none');
    tableBody.innerHTML = '';
    
    // RÃ©cupÃ©rer toutes les demandes de l'enseignant
    const params = new URLSearchParams();
    params.append('teacher_id', teacherId);
    
    fetch(`/api/requests?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            loadingIndicator.classList.add('d-none');
            
            // Grouper par nom de demande
            const groupedRequests = {};
            data.requests.forEach(request => {
                const requestName = request.request_name || 'Sans nom';
                if (!groupedRequests[requestName]) {
                    groupedRequests[requestName] = [];
                }
                groupedRequests[requestName].push(request);
            });
            
            // Afficher les groupes
            Object.keys(groupedRequests).forEach(requestName => {
                const requests = groupedRequests[requestName];
                const firstRequest = requests[0];
                
                // CrÃ©er la liste des horaires
                const scheduleList = requests.map(req => {
                    const date = formatDate(req.request_date);
                    const time = req.horaire || 'Pas d\'horaire';
                    return `${date} Ã  ${time}`;
                }).join('<br>');
                
                // CrÃ©er une ligne groupÃ©e
                const row = document.createElement('tr');
                row.className = 'table-warning'; // Couleur diffÃ©rente pour les groupes
                
                row.innerHTML = `
                    <td colspan="2"><strong>${requestName}</strong> (${requests.length} demande${requests.length > 1 ? 's' : ''})</td>
                    <td><span class="badge bg-primary">${requestName}</span></td>
                    <td><div class="small">${scheduleList}</div></td>
                    <td><span class="badge bg-info">${firstRequest.class_name}</span></td>
                    <td><span class="badge bg-secondary">${firstRequest.group_count || firstRequest.quantity || 1}</span></td>
                    <td><span class="badge bg-warning">${firstRequest.computers_needed || 0}</span></td>
                    <td>${firstRequest.material_description}</td>
                    <td><small class="text-muted">${firstRequest.material_prof || '<em>Aucun</em>'}</small></td>
                    <td><small class="text-muted">${firstRequest.notes || '<em>Aucune</em>'}</small></td>
                    <td><span class="badge bg-info">${requests.length} demande${requests.length > 1 ? 's' : ''}</span></td>
                    <td><button class="btn btn-outline-secondary btn-sm" onclick="expandGroup('${requestName}', ${teacherId})">ğŸ“‹ DÃ©tails</button></td>
                    <td><small class="text-muted">${formatDateTime(firstRequest.created_at)}</small></td>
                `;
                
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            loadingIndicator.classList.add('d-none');
            showErrorToast('Erreur lors du chargement des demandes groupÃ©es');
        });
}

// Fonction pour dÃ©velopper un groupe et voir les dÃ©tails
function expandGroup(requestName, teacherId) {
    // Basculer vers la vue normale et filtrer par ce nom de demande
    document.getElementById('groupByRequestName').checked = false;
    // Ici on pourrait ajouter un filtre par nom de demande si on le souhaite
    loadRequests();
    showSuccessToast(`Affichage des dÃ©tails pour: ${requestName}`);
}
</script>
{% endblock %}