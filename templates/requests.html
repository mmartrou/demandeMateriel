{% extends "base.html" %}

{% block title %}Toutes les Demandes - Demande de Mat√©riel{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-0">
                            üìã Toutes les Demandes de Mat√©riel
                        </h4>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-light btn-sm me-2" onclick="loadRequests()">
                            üîÑ Actualiser
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportRequests()">
                            üì• Export CSV
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="filterTeacher" class="form-label">Filtrer par enseignant:</label>
                        <select class="form-select" id="filterTeacher" onchange="loadRequests()">
                            <option value="">Tous les enseignants</option>
                            {% for teacher in teachers %}
                            <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterStartDate" class="form-label">Date de d√©but:</label>
                        <input type="date" class="form-control" id="filterStartDate" onchange="loadRequests()">
                    </div>
                    <div class="col-md-3">
                        <label for="filterEndDate" class="form-label">Date de fin:</label>
                        <input type="date" class="form-control" id="filterEndDate" onchange="loadRequests()">
                    </div>
                    <div class="col-md-3">
                        <label for="filterStatus" class="form-label">Statut:</label>
                        <select class="form-select" id="filterStatus" onchange="loadRequests()">
                            <option value="">Tous</option>
                            <option value="prepared">Pr√©par√©es</option>
                            <option value="not-prepared">Non pr√©par√©es</option>
                            <option value="modified">Modifi√©es</option>
                        </select>
                    </div>
                </div>
                
                <!-- Loading indicator -->
                <div id="loadingIndicator" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="requestsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Enseignant</th>
                                <th>üè∑Ô∏è Nom de demande</th>
                                <th>üìÖ Date</th>
                                <th>‚è∞ Horaire</th>
                                <th>üéì Niveau</th>
                                <th>üë• Groupes</th>
                                <th>üíª Ordinateurs</th>
                                <th>üìã Description</th>
                                <th>üî¨ Mat√©riel Prof</th>
                                <th>üìù Notes</th>
                                <th>üìÅ Image</th>
                                <th>üìä Statut</th>
                                <th>‚öôÔ∏è Actions</th>
                                <th>üìÖ Cr√©√© le</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <!-- Requests will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- No results message -->
                <div id="noResults" class="text-center text-muted d-none">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Aucune demande trouv√©e avec les filtres s√©lectionn√©s.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Request Modal -->
<div class="modal fade" id="editRequestModal" tabindex="-1" aria-labelledby="editRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRequestModalLabel">‚úèÔ∏è Modifier la Demande</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRequestForm">
                    <input type="hidden" id="editRequestId">
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="editTeacher" class="form-label">üë®‚Äçüè´ Enseignant *</label>
                            <select class="form-select" id="editTeacher" required>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="editRequestName" class="form-label">üè∑Ô∏è Nom de la demande *</label>
                            <input type="text" class="form-control" id="editRequestName" placeholder="Ex: TP Distillation, Contr√¥le Atomes..." required>
                            <div class="form-text">Obligatoire - Pour identifier et regrouper les demandes similaires</div>
                        </div>
                        <div class="col-md-4">
                            <label for="editDate" class="form-label">üìÖ Date *</label>
                            <input type="date" class="form-control" id="editDate" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editHoraire" class="form-label">‚è∞ Horaire</label>
                            <select class="form-select" id="editHoraire">
                                <option value="">S√©lectionner un horaire</option>
                                <optgroup label="üåÖ Matin">
                                    <option value="9h00">9h00</option>
                                    <option value="9h30">9h30</option>
                                    <option value="10h00">10h00</option>
                                    <option value="10h45">10h45</option>
                                    <option value="11h15">11h15</option>
                                    <option value="11h45">11h45</option>
                                    <option value="12h15">12h15</option>
                                    <option value="12h45">12h45</option>
                                </optgroup>
                                <optgroup label="üåá Apr√®s-midi">
                                    <option value="13h15">13h15</option>
                                    <option value="13h45">13h45</option>
                                    <option value="14h15">14h15</option>
                                    <option value="14h45">14h45</option>
                                    <option value="15h15">15h15</option>
                                    <option value="15h45">15h45</option>
                                    <option value="16h15">16h15</option>
                                    <option value="16h45">16h45</option>
                                    <option value="17h15">17h15</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editClassName" class="form-label">üéì Niveau/Classe *</label>
                            <select class="form-select" id="editClassName" required>
                                <option value="">S√©lectionner un niveau</option>
                                <option value="6√®me">6√®me</option>
                                <option value="5√®me">5√®me</option>
                                <option value="4√®me">4√®me</option>
                                <option value="3√®me">3√®me</option>
                                <option value="SNT">SNT</option>
                                <option value="SI">SI</option>
                                <option value="2nd Classe">2nd Classe</option>
                                <option value="2nd TP">2nd TP</option>
                                <option value="AP PP">AP PP</option>
                                <option value="AP 2nd">AP 2nd</option>
                                <option value="1√®re ES">1√®re ES</option>
                                <option value="Terminale ES">Terminale ES</option>
                                <option value="1√®re Sp√©cialit√©">1√®re Sp√©cialit√©</option>
                                <option value="Terminale Sp√©cialit√©">Terminale Sp√©cialit√©</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Cases Absent, Pas besoin de mat√©riel et Examen dans le modal -->
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editAbsent" name="editAbsent">
                                    <label class="form-check-label fw-bold" for="editAbsent">
                                        ‚ùå Absent (cocher si enseignant absent ce jour-l√†)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editNoMaterial" name="editNoMaterial">
                                    <label class="form-check-label fw-bold" for="editNoMaterial">
                                        üìö Pas besoin de mat√©riel (cours th√©orique)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editExamMode" name="editExamMode">
                                    <label class="form-check-label fw-bold" for="editExamMode">
                                        üìù Examen (surveillance d'examen)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">Si absent, pas besoin de mat√©riel, ou examen, seule la s√©lection du niveau sera n√©cessaire.</small>
                    </div>
                    
                    <!-- Nombre de groupes et ordinateurs d'abord -->
                    <div class="row mb-3" id="editQuantitySection">
                        <div class="col-md-4">
                            <label for="editQuantity" class="form-label">üî¢ Nombre de groupes</label>
                            <input type="number" class="form-control" id="editQuantity" min="1" value="1">
                        </div>
                        <div class="col-md-4">
                            <label for="editComputersNeeded" class="form-label">üíª Nombre d'ordinateurs</label>
                            <input type="number" class="form-control" id="editComputersNeeded" min="0" value="0">
                        </div>
                    </div>
                    
                    <!-- Mat√©riel sp√©cifique (checkboxes) -->
                    <div class="mb-3" id="editMaterialCheckboxSection">
                        <label class="form-label">
                            üîß Mat√©riel peu mobile √† avoir dans la salle
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="editEviers" name="editMaterials" value="√âviers">
                                    <label class="form-check-label" for="editEviers">
                                        √âviers
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="editHotte" name="editMaterials" value="Hotte">
                                    <label class="form-check-label" for="editHotte">
                                        Hotte
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="editBancsOptiques" name="editMaterials" value="Bancs optiques">
                                    <label class="form-check-label" for="editBancsOptiques">
                                        Bancs optiques
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="editOscilloscopes" name="editMaterials" value="Oscilloscopes">
                                    <label class="form-check-label" for="editOscilloscopes">
                                        Oscilloscopes
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="editBecsElectriques" name="editMaterials" value="Becs √©lectriques">
                                    <label class="form-check-label" for="editBecsElectriques">
                                        Becs √©lectriques
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="editSupportFiltration" name="editMaterials" value="Support de filtration">
                                    <label class="form-check-label" for="editSupportFiltration">
                                        Support de filtration
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="editImprimante" name="editMaterials" value="Imprimante">
                                    <label class="form-check-label" for="editImprimante">
                                        Imprimante
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Material description ensuite -->
                    <div class="mb-3" id="editMaterialSection">
                        <label for="editMaterialDescription" class="form-label">
                            üìù Mat√©riel requis par groupe
                        </label>
                        <textarea class="form-control" id="editMaterialDescription" rows="4" 
                                  placeholder="Ex: 2 Tubes √† essai, 1 verre de montre, 1 b√©cher 100mL, pipettes gradu√©es..."></textarea>
                    </div>
                    
                    <div class="mb-3" id="editMaterialProfSection">
                        <label for="editMaterialProf" class="form-label">üë®‚Äçüè´ Mat√©riel Prof</label>
                        <textarea class="form-control" id="editMaterialProf" rows="2" 
                                  placeholder="Mat√©riel n√©cessaire pour le professeur"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">üìù Notes suppl√©mentaires</label>
                        <textarea class="form-control" id="editNotes" rows="2"></textarea>
                    </div>
                    
                    <!-- Option pour modifier toutes les demandes li√©es -->
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editAllRelated" checked>
                                    <label class="form-check-label fw-bold" for="editAllRelated">
                                        üîó Modifier toutes les demandes li√©es (m√™me enseignant + m√™me nom)
                                    </label>
                                </div>
                                <small class="text-muted" id="relatedRequestsInfo">
                                    Les modifications s'appliqueront √† toutes les demandes du m√™me nom pour cet enseignant.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ajout d'une section d√©di√©e √† l'image -->
                    <div id="editImageSection" class="mb-3"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" onclick="deleteRequest()" title="Supprimer d√©finitivement cette demande">
                    üóëÔ∏è Supprimer
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveRequestChanges()">üíæ Sauvegarder</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de validation des modifications -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationModalLabel">üìù Valider les modifications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Les modifications suivantes sont en attente de validation :</p>
                <div id="modificationsPreview" class="mb-3">
                    <!-- Les modifications seront affich√©es ici -->
                </div>
                <div class="alert alert-info">
                    <strong>Note :</strong> Une fois valid√©es, ces modifications seront appliqu√©es d√©finitivement √† la demande.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" onclick="rejectModifications()" title="Rejeter et supprimer les modifications">
                    ‚ùå Rejeter
                </button>
                <button type="button" class="btn btn-success" onclick="validateModifications()" title="Appliquer les modifications">
                    ‚úÖ Valider
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales pour le suivi des modifications
let originalRequestData = {};
let modifiedRequests = new Map(); // Stocke les modifications pour chaque demande

// Gestion des cookies
function setCookie(name, value, days = 30) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
}

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

// Fonction pour comparer deux textes et g√©n√©rer un affichage avec les modifications
function generateDiffDisplay(originalText, newText) {
    if (originalText === newText) {
        return newText; // Aucun changement
    }
    
    // Diviser les textes en mots pour une comparaison plus fine
    const originalWords = originalText.split(/(\s+)/);
    const newWords = newText.split(/(\s+)/);
    
    let result = '';
    let i = 0, j = 0;
    
    // Algorithme simple de comparaison mot par mot
    while (i < originalWords.length || j < newWords.length) {
        if (i >= originalWords.length) {
            // Tous les mots restants sont des ajouts
            while (j < newWords.length) {
                if (newWords[j].trim()) {
                    result += `<span class="text-addition">${newWords[j]}</span>`;
                } else {
                    result += newWords[j]; // Pr√©server les espaces
                }
                j++;
            }
        } else if (j >= newWords.length) {
            // Tous les mots restants sont des suppressions
            while (i < originalWords.length) {
                if (originalWords[i].trim()) {
                    result += `<span class="text-deletion">${originalWords[i]}</span>`;
                } else {
                    result += originalWords[i]; // Pr√©server les espaces
                }
                i++;
            }
        } else if (originalWords[i] === newWords[j]) {
            // Mot identique
            result += originalWords[i];
            i++;
            j++;
        } else {
            // Chercher le mot suivant dans l'autre texte
            let foundInNew = -1;
            let foundInOriginal = -1;
            
            // Chercher le mot original dans le nouveau texte
            for (let k = j + 1; k < Math.min(newWords.length, j + 5); k++) {
                if (originalWords[i] === newWords[k]) {
                    foundInNew = k;
                    break;
                }
            }
            
            // Chercher le mot nouveau dans l'original
            for (let k = i + 1; k < Math.min(originalWords.length, i + 5); k++) {
                if (newWords[j] === originalWords[k]) {
                    foundInOriginal = k;
                    break;
                }
            }
            
            if (foundInNew !== -1 && (foundInOriginal === -1 || foundInNew - j < foundInOriginal - i)) {
                // Le mot original se trouve plus tard dans le nouveau texte
                // Traiter les mots entre j et foundInNew comme des ajouts
                for (let k = j; k < foundInNew; k++) {
                    if (newWords[k].trim()) {
                        result += `<span class="text-addition">${newWords[k]}</span>`;
                    } else {
                        result += newWords[k];
                    }
                }
                result += originalWords[i]; // Mot identique
                i++;
                j = foundInNew + 1;
            } else if (foundInOriginal !== -1) {
                // Le mot nouveau se trouve plus tard dans l'original
                // Traiter les mots entre i et foundInOriginal comme des suppressions
                for (let k = i; k < foundInOriginal; k++) {
                    if (originalWords[k].trim()) {
                        result += `<span class="text-deletion">${originalWords[k]}</span>`;
                    } else {
                        result += originalWords[k];
                    }
                }
                result += newWords[j]; // Mot identique
                i = foundInOriginal + 1;
                j++;
            } else {
                // Mots diff√©rents, traiter comme suppression + ajout
                if (originalWords[i].trim()) {
                    result += `<span class="text-deletion">${originalWords[i]}</span>`;
                } else {
                    result += originalWords[i];
                }
                if (newWords[j].trim()) {
                    result += `<span class="text-addition">${newWords[j]}</span>`;
                } else {
                    result += newWords[j];
                }
                i++;
                j++;
            }
        }
    }
    
    return result;
}

// Fonction pour enrichir l'affichage d'une demande avec les modifications
function enhanceRequestDisplay(request, fieldName, originalValue) {
    // V√©rifier d'abord les modifications locales (pour l'affichage imm√©diat apr√®s √©dition)
    const requestChanges = modifiedRequests.get(request.id.toString());
    
    if (requestChanges && requestChanges[fieldName]) {
        // Cette demande a √©t√© modifi√©e dans ce champ localement
        return `<div class="modified-field recently-modified">${requestChanges[fieldName].diff}</div>`;
    }
    
    // V√©rifier les modifications en attente dans la base de donn√©es
    const pendingMods = allPendingModifications.get(request.id);
    if (pendingMods) {
        const fieldModification = pendingMods.find(mod => mod.field_name === fieldName);
        if (fieldModification) {
            // G√©n√©rer l'affichage de la diff√©rence
            const diff = generateDiffDisplay(fieldModification.original_value, fieldModification.new_value);
            return `<div class="modified-field">${diff}</div>`;
        }
    }
    
    // Aucune modification, affichage normal
    return originalValue;
}

function initializeFilters() {
    // D√©finir automatiquement la date de d√©but √† aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('filterStartDate').value = today;
    
    // Restaurer l'enseignant depuis le cookie
    const savedTeacher = getCookie('selectedTeacher');
    if (savedTeacher) {
        const teacherSelect = document.getElementById('filterTeacher');
        teacherSelect.value = savedTeacher;
        console.log(`üç™ Enseignant restaur√© depuis le cookie: ${savedTeacher}`);
    }
    
    console.log(`üìÖ Date par d√©faut d√©finie: ${today}`);
}

    // Variables globales pour stocker les modifications en attente
let requestsWithPendingModifications = new Set();
let allPendingModifications = new Map(); // Map<requestId, modifications[]>

document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    loadRequestsWithPendingModifications();
    loadRequests();
});

function loadRequestsWithPendingModifications() {
    // Charger les IDs des demandes avec modifications
    fetch('/api/requests-with-pending-modifications')
        .then(response => response.json())
        .then(requestIds => {
            requestsWithPendingModifications = new Set(requestIds);
        })
        .catch(error => {
            console.error('Error loading pending modifications IDs:', error);
        });
    
    // Charger toutes les modifications en attente
    fetch('/api/pending-modifications')
        .then(response => response.json())
        .then(modifications => {
            allPendingModifications.clear();
            
            // Grouper les modifications par request_id
            modifications.forEach(mod => {
                const requestId = mod.request_id;
                if (!allPendingModifications.has(requestId)) {
                    allPendingModifications.set(requestId, []);
                }
                allPendingModifications.get(requestId).push(mod);
            });
        })
        .catch(error => {
            console.error('Error loading all pending modifications:', error);
        });
}function loadRequests() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const tableBody = document.getElementById('requestsTableBody');
    const noResults = document.getElementById('noResults');
    
    // Show loading
    loadingIndicator.classList.remove('d-none');
    tableBody.innerHTML = '';
    noResults.classList.add('d-none');
    
    // Get filter values
    const teacherId = document.getElementById('filterTeacher').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    // Sauvegarder l'enseignant s√©lectionn√© dans un cookie
    if (teacherId) {
        setCookie('selectedTeacher', teacherId);
        console.log(`üç™ Enseignant sauvegard√© dans le cookie: ${teacherId}`);
    }
    
    // Build query string
    const params = new URLSearchParams();
    if (teacherId) params.append('teacher_id', teacherId);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    // Fetch requests
    fetch(`/api/requests?${params.toString()}`)
        .then(response => response.json())
        .then(requests => {
            loadingIndicator.classList.add('d-none');
            
            // Stocker toutes les demandes pour pouvoir trouver les demandes li√©es
            window.allRequests = requests;
            
            if (requests.length === 0) {
                noResults.classList.remove('d-none');
                return;
            }
            
            // Filter by status if needed
            let filteredRequests = requests;
            if (statusFilter) {
                filteredRequests = requests.filter(request => {
                    switch(statusFilter) {
                        case 'prepared': return request.prepared === true;
                        case 'not-prepared': return request.prepared === false || !request.prepared;
                        case 'modified': return request.modified === true;
                        default: return true;
                    }
                });
            }
            
            // Populate table
            filteredRequests.forEach(request => {
                const row = document.createElement('tr');
                
                // V√©rifier si l'√©dition est possible (d√©lai 2 jours ouvr√©s)
                const canEdit = canEditRequest(request);
                row.style.cursor = canEdit ? 'pointer' : 'not-allowed';
                
                // Toujours permettre le double-clic pour ouvrir la modale (en lecture seule si n√©cessaire)
                row.addEventListener('dblclick', () => editRequest(request.id));
                
                if (canEdit) {
                    row.title = 'Double-cliquez pour modifier';
                } else {
                    row.title = 'Double-cliquez pour visualiser (modification impossible - moins de 2 jours ouvr√©s)';
                    row.style.opacity = '0.7';
                }
                
                const statusBadge = getStatusBadge(request);
                const preparedButton = getPreparedButton(request);
                const validationButton = getValidationButton(request);
                
                // Trouver les autres demandes du m√™me enseignant avec le m√™me nom
                const relatedRequests = window.allRequests.filter(r => 
                    r.teacher_id === request.teacher_id && 
                    r.request_name === request.request_name && 
                    r.request_name && // Seulement si le nom existe
                    r.id !== request.id // Exclure la demande actuelle
                );
                
                // Cr√©er la liste des autres horaires
                let otherSchedules = '';
                if (relatedRequests.length > 0) {
                    const schedules = relatedRequests.map(r => 
                        `${formatDate(r.request_date)} √† ${r.horaire || 'non sp√©cifi√©'}`
                    ).join(', ');
                    otherSchedules = `<br><small class="text-muted">üìÖ Autres horaires: ${schedules}</small>`;
                }
                
                // Am√©liorer l'affichage avec les modifications si elles existent
                const displayRequestName = enhanceRequestDisplay(request, 'request_name', 
                    `<span class="badge bg-primary">${request.request_name || '<em class="text-muted">Sans nom</em>'}</span>`);
                
                const displayHoraire = enhanceRequestDisplay(request, 'horaire', 
                    `<span class="badge bg-success">${request.horaire || '-'}</span>`);
                
                const displayClassName = enhanceRequestDisplay(request, 'class_name', 
                    `<span class="badge bg-info">${request.class_name}</span>`);
                
                const displayQuantity = enhanceRequestDisplay(request, 'quantity', 
                    `<span class="badge bg-secondary">${request.group_count || request.quantity || 1}</span>`);
                
                const displayComputersNeeded = enhanceRequestDisplay(request, 'computers_needed', 
                    `<span class="badge bg-warning">${request.computers_needed || 0}</span>`);
                
                const displayMaterialDescription = enhanceRequestDisplay(request, 'material_description', 
                    request.material_description);
                
                const displayMaterialProf = enhanceRequestDisplay(request, 'material_prof', 
                    `<small class="text-muted" style="white-space: pre-wrap;">${request.material_prof || '<em>Aucun</em>'}</small>`);
                
                const displayNotes = enhanceRequestDisplay(request, 'notes', 
                    `<span style="white-space: pre-wrap;">${request.notes || '<em class="text-muted">Aucune</em>'}</span>`);

                // Gestion de l'affichage de l'image
                let displayImage = '<em class="text-muted">Aucune</em>';
                if (request.image_url && request.image_url.trim()) {
                    displayImage = `
                        <img src="${request.image_url}" 
                             alt="Image de la demande" 
                             class="img-thumbnail" 
                             style="max-width: 50px; max-height: 50px; cursor: pointer;"
                             onclick="showImageModal('${request.image_url}', 'Demande #${request.id} - ${request.teacher_name}')"
                             title="Cliquez pour agrandir">
                    `;
                }

                // V√©rifier si la demande peut √™tre modifi√©e
                const canEditRow = canEditRequest(request);
                const rowStyle = canEditRow ? 'cursor: pointer;' : 'cursor: pointer; opacity: 0.7;';
                const tooltip = canEditRow ? 'Double-cliquez pour modifier' : 'Double-cliquez pour visualiser (modification impossible - moins de 2 jours ouvr√©s)';
                
                row.innerHTML = `
                    <td>${request.id}</td>
                    <td><div class="fw-bold">${request.teacher_name || '<em class="text-muted">Nom manquant</em>'}</div></td>
                    <td>${displayRequestName}</td>
                    <td>${formatDate(request.request_date)}${otherSchedules}</td>
                    <td>${displayHoraire}</td>
                    <td>${displayClassName}</td>
                    <td>${displayQuantity}</td>
                    <td>${displayComputersNeeded}</td>
                    <td>${displayMaterialDescription}</td>
                    <td>${displayMaterialProf}</td>
                    <td>${displayNotes}</td>
                    <td>${displayImage}</td>
                    <td>${statusBadge}</td>
                    <td>
                        ${preparedButton}
                        ${validationButton ? `<br class="d-block d-sm-none">${validationButton}` : ''}
                    </td>
                    <td><small class="text-muted">${formatDateTime(request.created_at)}</small></td>
                `;
                
                // Ajouter le style et le double-clic √† la ligne
                row.style.cssText = rowStyle;
                row.title = tooltip;
                row.addEventListener('dblclick', () => editRequest(request.id));
                
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            loadingIndicator.classList.add('d-none');
            showErrorToast('Erreur lors du chargement des demandes');
        });
}

function exportRequests() {
    // Get filter values
    const teacherId = document.getElementById('filterTeacher').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    
    // Build query string
    const params = new URLSearchParams();
    if (teacherId) params.append('teacher_id', teacherId);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    // Open export URL
    window.open(`/export/csv?${params.toString()}`, '_blank');
    showSuccessToast('Export CSV en cours...');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${day}/${month}/${year} ${hours}:${minutes}`;
}

function getStatusBadge(request) {
    let badges = [];
    if (request.prepared) {
        badges.push('<span class="badge bg-success">‚úÖ Pr√©par√©e</span>');
    } else {
        badges.push('<span class="badge bg-light text-dark">‚è≥ Non pr√©par√©e</span>');
    }
    if (request.modified) {
        badges.push('<span class="badge bg-warning">‚ö†Ô∏è Modifi√©e</span>');
    }
    return badges.join(' ');
}

function getPreparedButton(request) {
    const buttonClass = request.prepared ? 'btn-outline-success' : 'btn-outline-secondary';
    const buttonText = request.prepared ? '‚úÖ Pr√©par√©e' : '‚è≥ Marquer pr√©par√©e';
    return `<button class="btn btn-sm ${buttonClass}" onclick="togglePrepared(${request.id}); event.stopPropagation();">${buttonText}</button>`;
}

function getValidationButton(request) {
    if (requestsWithPendingModifications.has(request.id)) {
        // V√©rifier si la demande peut encore √™tre modifi√©e (d√©lai 2 jours ouvr√©s)
        if (!canEditRequest(request)) {
            return `<span class="btn btn-sm btn-secondary disabled" title="D√©lai insuffisant - impossible de valider (moins de 2 jours ouvr√©s)">
                        üîí D√©lai d√©pass√©
                    </span>`;
        }
        return `<button class="btn btn-sm btn-warning" onclick="showValidationModal(${request.id}); event.stopPropagation();" title="Valider les modifications en attente">
                    üìù Valider modifications
                </button>`;
    }
    return '';
}

function canEditRequest(request) {
    // Calculer si on a au moins 2 jours ouvr√©s avant la date de la demande
    const requestDate = new Date(request.request_date + 'T08:00:00'); // Cours √† 8h
    const now = new Date();
    
    let workingDaysCount = 0;
    let checkDate = new Date(now);
    checkDate.setDate(now.getDate() + 1); // Commencer par demain
    
    while (checkDate < requestDate) {
        const dayOfWeek = checkDate.getDay();
        // Lundi = 1, Mardi = 2, ..., Vendredi = 5 (jours ouvr√©s)
        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
            workingDaysCount++;
        }
        checkDate.setDate(checkDate.getDate() + 1);
    }
    
    return workingDaysCount >= 2;
}

function showRequestInReadOnlyMode(request) {
    // Remplir le formulaire avec les donn√©es de la demande
    populateEditForm(request);
    
    // D√©sactiver tous les champs de saisie
    const formElements = document.querySelectorAll('#editRequestModal input, #editRequestModal select, #editRequestModal textarea');
    formElements.forEach(element => {
        element.disabled = true;
    });
    
    // Masquer le bouton de sauvegarde
    const saveButton = document.querySelector('#editRequestModal .btn-primary');
    if (saveButton) {
        saveButton.style.display = 'none';
    }
    
    // Ajouter un message d'information
    const modalBody = document.querySelector('#editRequestModal .modal-body');
    let infoMessage = modalBody.querySelector('.readonly-info-message');
    if (!infoMessage) {
        infoMessage = document.createElement('div');
        infoMessage.className = 'readonly-info-message alert alert-info mb-3';
        infoMessage.innerHTML = '<i class="fas fa-info-circle"></i> Cette demande ne peut plus √™tre modifi√©e car elle est programm√©e dans moins de 2 jours ouvr√©s. Vous pouvez consulter les d√©tails ci-dessous.';
        modalBody.insertBefore(infoMessage, modalBody.firstChild);
    }
    
    // Changer le titre de la modale
    const modalTitle = document.querySelector('#editRequestModal .modal-title');
    if (modalTitle) {
        modalTitle.textContent = 'Visualisation de la demande';
    }
    
    // Marquer la modale comme √©tant en mode lecture seule
    document.getElementById('editRequestModal').setAttribute('data-readonly', 'true');
    
    // Nettoyer les backdrops avant d'afficher la modale
    clearModalBackdrops();
    
    // Afficher la modale simplement
    const modal = new bootstrap.Modal(document.getElementById('editRequestModal'));
    modal.show();
}

function populateEditForm(request) {
    // Check if this is a special request type
    const isAbsent = request.selected_materials === 'Absent' && request.material_description === 'Enseignant absent';
    const isNoMaterial = request.selected_materials === 'Pas besoin de mat√©riel' && request.material_description === 'Cours th√©orique sans mat√©riel';
    const isExamMode = request.selected_materials === 'Examen' && request.material_description === 'Surveillance d\'examen';
    
    // Populate form - with safety checks
    const editRequestId = document.getElementById('editRequestId');
    const editTeacher = document.getElementById('editTeacher');
    const editRequestName = document.getElementById('editRequestName');
    const editDate = document.getElementById('editDate');
    const editHoraire = document.getElementById('editHoraire');
    const editClassName = document.getElementById('editClassName');
    const editAbsent = document.getElementById('editAbsent');
    const editNoMaterial = document.getElementById('editNoMaterial');
    const editExamMode = document.getElementById('editExamMode');
    
    if (editRequestId) editRequestId.value = request.id;
    if (editTeacher) editTeacher.value = request.teacher_id;
    if (editRequestName) editRequestName.value = request.request_name || '';
    if (editDate) editDate.value = request.request_date;
    if (editHoraire) editHoraire.value = request.horaire || '';
    if (editClassName) editClassName.value = request.class_name;
    if (editAbsent) editAbsent.checked = isAbsent;
    if (editNoMaterial) editNoMaterial.checked = isNoMaterial;
    if (editExamMode) editExamMode.checked = isExamMode;
    
    const editQuantity = document.getElementById('editQuantity');
    const editComputersNeeded = document.getElementById('editComputersNeeded');
    const editMaterialProf = document.getElementById('editMaterialProf');
    const editNotes = document.getElementById('editNotes');
    
    if (editQuantity) editQuantity.value = request.group_count || request.quantity || 1;
    if (editComputersNeeded) editComputersNeeded.value = request.computers_needed || 0;
    if (editMaterialProf) editMaterialProf.value = request.material_prof || '';
    if (editNotes) editNotes.value = request.notes || '';
    
    // Parser et cocher les mat√©riaux sp√©cifiques
    parseAndSetSpecificMaterials(request.selected_materials || '');
    
    // G√©rer l'affichage de l'image (compatible avec diff√©rents √©l√©ments)
    const currentImageDiv = document.getElementById('editCurrentImage');
    const imageSection = document.getElementById('editImageSection');
    
    const imageElement = currentImageDiv || imageSection;
    if (imageElement) {
        if (request.image_url && request.image_url.trim()) {
            const imageHtml = currentImageDiv ? `
                <div class="mb-2">
                    <label class="form-label">Image actuelle :</label><br>
                    <img src="${request.image_url}" alt="Image actuelle" class="img-thumbnail" style="max-width: 200px; max-height: 200px; cursor: pointer;" onclick="showImageModal('${request.image_url}', 'Demande #${request.id}')">
                </div>
            ` : `
                <div class="mb-2 text-center">
                    <img src="${request.image_url}" alt="Image de la demande" class="img-thumbnail" style="max-width:120px;max-height:120px;cursor:pointer;" onclick="showImageModal('${request.image_url}', 'Demande #${request.id} - ${request.teacher_name}')">
                    <div><small class="text-muted">Cliquez pour agrandir</small></div>
                </div>
            `;
            imageElement.innerHTML = imageHtml;
        } else {
            imageElement.innerHTML = currentImageDiv ? 
                '<p class="text-muted">Aucune image associ√©e</p>' : 
                '<em class="text-muted">Aucune image associ√©e</em>';
        }
    }
}



function parseAndSetSpecificMaterials(selectedMaterials) {
    // R√©initialiser toutes les checkboxes des mat√©riaux sp√©cifiques
    const materialCheckboxes = document.querySelectorAll('input[name="editMaterials"]');
    materialCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Parser le texte des mat√©riaux pour identifier les mat√©riaux sp√©cifiques
    if (selectedMaterials && selectedMaterials.trim()) {
        const materials = selectedMaterials.split('\n').map(line => line.replace(/^-\s*/, '').trim());
        
        // Liste des mat√©riaux sp√©cifiques reconnus
        const specificMaterialsMap = {
            '√âviers': 'editEviers',
            'Hotte': 'editHotte', 
            'Bancs optiques': 'editBancsOptiques',
            'Oscilloscopes': 'editOscilloscopes',
            'Becs √©lectriques': 'editBecsElectriques',
            'Support de filtration': 'editSupportFiltration',
            'Imprimante': 'editImprimante'
        };
        
        const remainingMaterials = [];
        
        materials.forEach(material => {
            let isSpecificMaterial = false;
            
            // V√©rifier si c'est un mat√©riel sp√©cifique
            for (const [specificName, checkboxId] of Object.entries(specificMaterialsMap)) {
                if (material.toLowerCase().includes(specificName.toLowerCase()) || 
                    material === specificName) {
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                    isSpecificMaterial = true;
                    break;
                }
            }
            
            // Si ce n'est pas un mat√©riel sp√©cifique, l'ajouter aux mat√©riaux libres
            if (!isSpecificMaterial && material.trim()) {
                remainingMaterials.push(material);
            }
        });
        
        // Mettre les mat√©riaux non-sp√©cifiques dans la zone de texte
        const editMaterialDescription = document.getElementById('editMaterialDescription');
        if (editMaterialDescription) {
            editMaterialDescription.value = remainingMaterials.join('\n');
        }
    } else {
        // Pas de mat√©riaux, vider la zone de texte
        const editMaterialDescription = document.getElementById('editMaterialDescription');
        if (editMaterialDescription) {
            editMaterialDescription.value = '';
        }
    }
}

function clearModalBackdrops() {
    // Supprimer tous les backdrops qui tra√Ænent
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => {
        backdrop.remove();
    });
    
    // Remettre le body en √©tat normal
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
}

// Fonction d'urgence accessible globalement pour d√©bloquer l'interface
window.emergencyUnblock = function() {
    clearModalBackdrops();
    // Fermer toutes les modales ouvertes
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(modal => {
        const instance = bootstrap.Modal.getInstance(modal);
        if (instance) {
            instance.hide();
        }
    });
    console.log('Interface d√©bloqu√©e');
};

function resetEditForm() {
    try {
        // Nettoyer les backdrops avant tout
        clearModalBackdrops();
        
        // R√©activer tous les champs
        const formElements = document.querySelectorAll('#editRequestModal input, #editRequestModal select, #editRequestModal textarea');
        formElements.forEach(element => {
            if (element) element.disabled = false;
        });
        
        // R√©afficher le bouton de sauvegarde
        const saveButton = document.querySelector('#editRequestModal .btn-primary');
        if (saveButton) {
            saveButton.style.display = '';
        }
        
        // Supprimer le message d'information
        const infoMessage = document.querySelector('#editRequestModal .readonly-info-message');
        if (infoMessage) {
            infoMessage.remove();
        }
        
        // Remettre le titre original
        const modalTitle = document.querySelector('#editRequestModal .modal-title');
        if (modalTitle) {
            modalTitle.textContent = 'Modifier la demande';
        }
    } catch (error) {
        console.error('Erreur dans resetEditForm:', error);
        // En cas d'erreur, forcer le nettoyage des backdrops
        clearModalBackdrops();
    }
}

function editRequest(requestId) {
    // Fetch request details
    fetch(`/api/requests/${requestId}`)
        .then(response => response.json())
        .then(request => {
            // V√©rifier si la demande peut √™tre modifi√©e (d√©lai 2 jours ouvr√©s)
            const canEdit = canEditRequest(request);
            if (!canEdit) {
                // Mode lecture seule - afficher la modale mais bloquer les modifications
                showRequestInReadOnlyMode(request);
                return;
            }
            // Sauvegarder l'√©tat original de la demande pour le suivi des modifications
            originalRequestData = {
                request_name: request.request_name || '',
                class_name: request.class_name || '',
                material_description: request.material_description || '',
                material_prof: request.material_prof || '',
                notes: request.notes || '',
                horaire: request.horaire || '',
                quantity: request.group_count || request.quantity || 1,
                computers_needed: request.computers_needed || 0,
                selected_materials: request.selected_materials || ''
            };
            
            // S'assurer que la modale est en mode √©dition (nettoyer le mode lecture seule si n√©cessaire)
            const modalElement = document.getElementById('editRequestModal');
            if (modalElement && modalElement.getAttribute('data-readonly') === 'true') {
                resetEditForm();
            }
            modalElement.removeAttribute('data-readonly');
            
            // Utiliser la fonction centralis√©e pour remplir le formulaire
            populateEditForm(request);
            
            // Stocker les valeurs originales pour la mise √† jour group√©e
            const editRequestId = document.getElementById('editRequestId');
            if (editRequestId) {
                editRequestId.setAttribute('data-teacher-id', request.teacher_id);
                editRequestId.setAttribute('data-request-name', request.request_name || '');
            }

            // Red√©finir les variables pour les modes sp√©ciaux (utilis√©es plus loin)
            const isAbsent = request.selected_materials === 'Absent' && request.material_description === 'Enseignant absent';
            const isNoMaterial = request.selected_materials === 'Pas besoin de mat√©riel' && request.material_description === 'Cours th√©orique sans mat√©riel';
            const isExamMode = request.selected_materials === 'Examen' && request.material_description === 'Surveillance d\'examen';
            
            // Calculer le nombre de demandes li√©es (m√™me enseignant + m√™me nom)
            let relatedCount = 0;
            if (window.allRequests && request.request_name) {
                relatedCount = window.allRequests.filter(r => 
                    r.teacher_id === request.teacher_id && 
                    r.request_name === request.request_name &&
                    r.request_name // Seulement si le nom existe
                ).length;
            }
            
            // Mettre √† jour le texte d'information et la checkbox
            const relatedInfo = document.getElementById('relatedRequestsInfo');
            const bulkCheckbox = document.getElementById('editAllRelated');
            
            if (relatedCount > 1) {
                relatedInfo.textContent = `${relatedCount} demandes seront modifi√©es simultan√©ment (m√™me enseignant + m√™me nom "${request.request_name}").`;
                relatedInfo.className = 'text-info fw-bold';
                // Cocher par d√©faut s'il y a des demandes li√©es
                bulkCheckbox.checked = true;
                bulkCheckbox.disabled = false;
            } else {
                relatedInfo.textContent = 'Aucune autre demande li√©e trouv√©e. Seule cette demande sera modifi√©e.';
                relatedInfo.className = 'text-muted';
                // D√©cocher et d√©sactiver s'il n'y a pas de demandes li√©es
                bulkCheckbox.checked = false;
                bulkCheckbox.disabled = true;
            }
            
            // Fill material description field
            const editMaterialDescription = document.getElementById('editMaterialDescription');
            if (!editMaterialDescription) {
                throw new Error('Champ description du mat√©riel manquant');
            }
            
            if (isAbsent || isNoMaterial || isExamMode) {
                // Pour les modes sp√©ciaux, laisser vide
                editMaterialDescription.value = '';
            } else {
                // Pour les demandes normales, extraire le mat√©riel de material_description
                let materialContent = request.material_description || '';
                
                // Si la description commence par "Mat√©riel requis: ", extraire seulement la partie apr√®s
                if (materialContent.startsWith('Mat√©riel requis: ')) {
                    materialContent = materialContent.substring('Mat√©riel requis: '.length);
                }
                
                editMaterialDescription.value = materialContent;
            }
            
            // Toggle sections based on special modes
            toggleEditSpecialModes();
            
            // Nettoyer les backdrops avant d'afficher la modale
            clearModalBackdrops();
            
            // Afficher la modale simplement
            const modal = new bootstrap.Modal(document.getElementById('editRequestModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading request:', error);
            showErrorToast('Erreur lors du chargement de la demande: ' + error.message);
        });
}

// Fonction pour calculer et stocker les diff√©rences avant sauvegarde
function calculateRequestChanges(requestId, newData) {
    const changes = {};
    
    // Comparer chaque champ modifiable
    const fieldsToCompare = ['request_name', 'class_name', 'material_description', 'material_prof', 'notes', 'horaire'];
    
    for (const field of fieldsToCompare) {
        const originalValue = originalRequestData[field] || '';
        const newValue = newData[field] || '';
        
        if (originalValue !== newValue) {
            changes[field] = {
                original: originalValue,
                new: newValue,
                diff: generateDiffDisplay(originalValue, newValue)
            };
        }
    }
    
    // Comparer les mat√©riels sp√©cifiques (selected_materials)
    const originalMaterials = originalRequestData.selected_materials || '';
    const newMaterials = newData.selected_materials || '';
    
    if (originalMaterials !== newMaterials) {
        changes.selected_materials = {
            original: originalMaterials,
            new: newMaterials,
            diff: generateDiffDisplay(originalMaterials, newMaterials)
        };
    }
    
    // Comparer les champs num√©riques
    if (originalRequestData.quantity !== newData.quantity) {
        changes.quantity = {
            original: originalRequestData.quantity,
            new: newData.quantity,
            diff: `${originalRequestData.quantity} ‚Üí ${newData.quantity}`
        };
    }
    
    if (originalRequestData.computers_needed !== newData.computers_needed) {
        changes.computers_needed = {
            original: originalRequestData.computers_needed,
            new: newData.computers_needed,
            diff: `${originalRequestData.computers_needed} ‚Üí ${newData.computers_needed}`
        };
    }
    
    // Stocker les changements si il y en a
    if (Object.keys(changes).length > 0) {
        modifiedRequests.set(requestId, changes);
    } else {
        modifiedRequests.delete(requestId); // Supprimer si aucun changement
    }
    
    return changes;
}

// Fonction pour sauvegarder les modifications en attente
async function savePendingModifications(requestId, changes) {
    const pendingPromises = [];
    
    for (const [fieldName, change] of Object.entries(changes)) {
        const pendingModification = {
            request_id: requestId,
            field_name: fieldName,
            original_value: change.original,
            new_value: change.new,
            modified_by: 'User' // Peut √™tre personnalis√© plus tard
        };
        
        const promise = fetch('/api/pending-modifications', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(pendingModification)
        });
        
        pendingPromises.push(promise);
    }
    
    try {
        await Promise.all(pendingPromises);
        return true;
    } catch (error) {
        console.error('Erreur lors de la sauvegarde des modifications en attente:', error);
        return false;
    }
}

function saveRequestChanges() {
    const requestId = document.getElementById('editRequestId').value;
    const isAbsent = document.getElementById('editAbsent').checked;
    const isNoMaterial = document.getElementById('editNoMaterial').checked;
    const isExamMode = document.getElementById('editExamMode').checked;
    const bulkEdit = document.getElementById('editAllRelated').checked;
    
    const currentData = {
        request_name: document.getElementById('editRequestName').value,
        horaire: document.getElementById('editHoraire').value,
        class_name: document.getElementById('editClassName').value,
        quantity: parseInt(document.getElementById('editQuantity').value) || 1,
        computers_needed: parseInt(document.getElementById('editComputersNeeded').value) || 0,
        material_prof: document.getElementById('editMaterialProf').value,
        notes: document.getElementById('editNotes').value
    };

    const formData = {
        teacher_id: parseInt(document.getElementById('editTeacher').value),
        request_name: currentData.request_name,
        request_date: document.getElementById('editDate').value,
        horaire: currentData.horaire,
        class_name: currentData.class_name,
        quantity: currentData.quantity,
        group_count: currentData.quantity,
        computers_needed: currentData.computers_needed,
        material_prof: currentData.material_prof,
        notes: currentData.notes
    };
    
    if (isAbsent) {
        formData.selected_materials = 'Absent';
        formData.material_description = 'Enseignant absent';
        currentData.selected_materials = formData.selected_materials;
        currentData.material_description = formData.material_description;
    } else if (isNoMaterial) {
        formData.selected_materials = 'Pas besoin de mat√©riel';
        formData.material_description = 'Cours th√©orique sans mat√©riel';
        currentData.selected_materials = formData.selected_materials;
        currentData.material_description = formData.material_description;
    } else if (isExamMode) {
        formData.selected_materials = 'Examen';
        formData.material_description = 'Surveillance d\'examen';
        currentData.selected_materials = formData.selected_materials;
        currentData.material_description = formData.material_description;
    } else {
        // Collecter les mat√©riaux sp√©cifiques coch√©s (pour selected_materials seulement)
        const specificMaterials = [];
        const materialCheckboxes = document.querySelectorAll('input[name="editMaterials"]:checked');
        materialCheckboxes.forEach(checkbox => {
            specificMaterials.push(checkbox.value);
        });
        
        // R√©cup√©rer le contenu du champ mat√©riel libre
        const freeTextMaterial = document.getElementById('editMaterialDescription').value;
        
        // Pour selected_materials : inclure tous les mat√©riaux (sp√©cifiques + libres)
        let allMaterials = [];
        if (specificMaterials.length > 0) {
            allMaterials.push(...specificMaterials);
        }
        if (freeTextMaterial && freeTextMaterial.trim()) {
            allMaterials.push(freeTextMaterial.trim());
        }
        
        formData.selected_materials = allMaterials.join('\n- ');
        if (formData.selected_materials) {
            formData.selected_materials = '- ' + formData.selected_materials; // Ajouter le premier tiret
        }
        
        // Pour material_description : seulement le mat√©riel libre (pas les √©quipements de salle)
        if (freeTextMaterial && freeTextMaterial.trim()) {
            formData.material_description = `Mat√©riel requis: ${freeTextMaterial.trim()}`;
        } else {
            formData.material_description = 'Cours sans mat√©riel sp√©cifique';
        }
    }
    
    // Ajouter material_description et selected_materials au currentData pour la comparaison
    currentData.material_description = formData.material_description;
    currentData.selected_materials = formData.selected_materials;
    
    // Calculer les changements avant la sauvegarde
    const changes = calculateRequestChanges(requestId, currentData);
    
    // V√©rifier s'il y a des changements √† sauvegarder
    if (Object.keys(changes).length === 0) {
        showSuccessToast('Aucune modification d√©tect√©e');
        // Fermer le modal
        const modalElement = document.getElementById('editRequestModal');
        const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
        modal.hide();
        return;
    }
    
    // Sauvegarder les modifications en attente au lieu de les appliquer directement
    let savePromise;
    let relatedRequestsCount = 1;
    
    if (bulkEdit) {
        // Modification group√©e - sauvegarder pour toutes les demandes li√©es
        const originalTeacherId = parseInt(document.getElementById('editRequestId').getAttribute('data-teacher-id'));
        const originalRequestName = document.getElementById('editRequestId').getAttribute('data-request-name');
        
        if (!window.allRequests) {
            throw new Error('Les donn√©es des demandes ne sont pas disponibles. Veuillez rafra√Æchir la page.');
        }
        
        const relatedRequests = window.allRequests.filter(req => 
            req.teacher_id === originalTeacherId && 
            req.request_name === originalRequestName
        );
        
        relatedRequestsCount = relatedRequests.length;
        
        // Sauvegarder les modifications en attente pour chaque demande
        const savePromises = relatedRequests.map(req => 
            savePendingModifications(req.id, changes)
        );
        
        savePromise = Promise.all(savePromises);
    } else {
        // Modification individuelle
        savePromise = savePendingModifications(requestId, changes);
    }
    
    savePromise
    .then(success => {
        if (!success) {
            throw new Error('Erreur lors de la sauvegarde des modifications');
        }
        
        // Hide modal - Use multiple methods to ensure it closes
        const modalElement = document.getElementById('editRequestModal');
        
        // Method 1: Try to get existing modal instance
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        } else {
            // Method 2: Create new modal instance if none exists
            modal = new bootstrap.Modal(modalElement);
            modal.hide();
        }
        
        // Method 3: Fallback - remove modal classes manually
        setTimeout(() => {
            modalElement.classList.remove('show');
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }, 100);
        
        // Mettre √† jour les Maps locales pour l'affichage imm√©diat
        if (bulkEdit && Object.keys(changes).length > 0) {
            const originalTeacherId = parseInt(document.getElementById('editRequestId').getAttribute('data-teacher-id'));
            const originalRequestName = document.getElementById('editRequestId').getAttribute('data-request-name');
            
            if (window.allRequests) {
                const relatedRequests = window.allRequests.filter(req => 
                    req.teacher_id === originalTeacherId && 
                    req.request_name === originalRequestName
                );
                
                relatedRequests.forEach(req => {
                    // Mettre √† jour la Map locale pour l'affichage imm√©diat
                    modifiedRequests.set(req.id.toString(), changes);
                    
                    // Mettre √† jour la Map globale des modifications en attente
                    if (!allPendingModifications.has(req.id)) {
                        allPendingModifications.set(req.id, []);
                    }
                    
                    // Ajouter les nouvelles modifications √† la liste
                    Object.entries(changes).forEach(([fieldName, change]) => {
                        const modification = {
                            request_id: req.id,
                            field_name: fieldName,
                            original_value: change.original,
                            new_value: change.new
                        };
                        
                        allPendingModifications.get(req.id).push(modification);
                    });
                    
                    // Ajouter √† la liste des demandes avec modifications
                    requestsWithPendingModifications.add(req.id);
                });
            }
        }
        
        // Reload requests pour afficher le bouton de validation
        loadRequestsWithPendingModifications();
        loadRequests();
        
        // Message de succ√®s adapt√©
        const successMessage = bulkEdit ? 
            `${relatedRequestsCount} modifications sauvegard√©es en attente de validation` : 
            'Modifications sauvegard√©es en attente de validation';
        showSuccessToast(successMessage);
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Erreur lors de la sauvegarde: ' + error.message);
    });
}

// Variables globales pour le modal de validation
let currentValidationRequestId = null;

function showValidationModal(requestId) {
    currentValidationRequestId = requestId;
    
    // Trouver la demande actuelle pour identifier les demandes li√©es
    const currentRequest = window.allRequests.find(req => req.id === requestId);
    if (!currentRequest) {
        showErrorToast('Erreur: Demande non trouv√©e');
        return;
    }
    
    // Charger les modifications en attente pour cette demande
    fetch(`/api/pending-modifications?request_id=${requestId}`)
        .then(response => response.json())
        .then(modifications => {
            // Compter les demandes li√©es avec des modifications
            const relatedRequestsWithModifications = window.allRequests.filter(req => 
                req.teacher_id === currentRequest.teacher_id && 
                req.request_name === currentRequest.request_name &&
                requestsWithPendingModifications.has(req.id)
            );
            
            displayModificationsPreview(modifications, relatedRequestsWithModifications.length);
            
            // Afficher le modal
            const modal = new bootstrap.Modal(document.getElementById('validationModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading pending modifications:', error);
            showErrorToast('Erreur lors du chargement des modifications');
        });
}

function displayModificationsPreview(modifications, relatedCount = 1) {
    const previewContainer = document.getElementById('modificationsPreview');
    
    if (modifications.length === 0) {
        previewContainer.innerHTML = '<p class="text-muted">Aucune modification en attente.</p>';
        return;
    }
    
    let html = '';
    
    // Afficher l'information sur les demandes li√©es
    if (relatedCount > 1) {
        html += `<div class="alert alert-info">
            <strong>üìã Demandes li√©es :</strong> Cette action s'appliquera √† <strong>${relatedCount} demandes</strong> 
            du m√™me enseignant avec le m√™me nom.
        </div>`;
    }
    
    html += '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Champ</th><th>Valeur actuelle</th><th>Nouvelle valeur</th></tr></thead><tbody>';
    
    modifications.forEach(mod => {
        const fieldLabel = getFieldLabel(mod.field_name);
        html += `
            <tr>
                <td><strong>${fieldLabel}</strong></td>
                <td><span class="text-muted">${mod.original_value || '<em>Vide</em>'}</span></td>
                <td><span class="text-primary fw-bold">${mod.new_value || '<em>Vide</em>'}</span></td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    previewContainer.innerHTML = html;
}

function getFieldLabel(fieldName) {
    const labels = {
        'request_name': 'Nom de la demande',
        'class_name': 'Classe',
        'material_description': 'Description du mat√©riel',
        'material_prof': 'Mat√©riel professeur',
        'notes': 'Notes',
        'horaire': 'Horaire',
        'quantity': 'Nombre de groupes',
        'computers_needed': 'Ordinateurs n√©cessaires'
    };
    return labels[fieldName] || fieldName;
}

function validateModifications() {
    if (!currentValidationRequestId) {
        showErrorToast('Erreur: Aucune demande s√©lectionn√©e');
        return;
    }
    
    // D'abord, r√©cup√©rer les informations de la demande pour trouver les demandes li√©es
    const currentRequest = window.allRequests.find(req => req.id === currentValidationRequestId);
    if (!currentRequest) {
        showErrorToast('Erreur: Demande non trouv√©e');
        return;
    }
    
    // Trouver toutes les demandes li√©es (m√™me enseignant + m√™me nom) qui ont des modifications en attente
    const relatedRequestsWithModifications = window.allRequests.filter(req => 
        req.teacher_id === currentRequest.teacher_id && 
        req.request_name === currentRequest.request_name &&
        requestsWithPendingModifications.has(req.id)
    );
    
    if (relatedRequestsWithModifications.length === 0) {
        showErrorToast('Aucune modification en attente trouv√©e');
        return;
    }
    
    // Valider toutes les demandes li√©es
    const validationPromises = relatedRequestsWithModifications.map(req => 
        fetch(`/api/pending-modifications/${req.id}/validate`, {
            method: 'POST'
        }).then(response => response.json())
    );
    
    Promise.all(validationPromises)
    .then(results => {
        // V√©rifier s'il y a des erreurs
        const errors = results.filter(result => result.error);
        if (errors.length > 0) {
            throw new Error(`Erreurs lors de la validation: ${errors.map(e => e.error).join(', ')}`);
        }
        
        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('validationModal'));
        modal.hide();
        
        // Nettoyer les Maps locales et mettre √† jour les objets de demandes
        relatedRequestsWithModifications.forEach(req => {
            modifiedRequests.delete(req.id.toString());
            allPendingModifications.delete(req.id);
            requestsWithPendingModifications.delete(req.id);
            
            // Mettre √† jour l'objet de la demande pour refl√©ter que modified = false
            const requestInList = window.allRequests.find(r => r.id === req.id);
            if (requestInList) {
                requestInList.modified = false;
            }
        });
        
        // Rafra√Æchir la liste
        loadRequestsWithPendingModifications();
        loadRequests();
        
        const successMessage = relatedRequestsWithModifications.length > 1 ? 
            `${relatedRequestsWithModifications.length} demandes valid√©es avec succ√®s` : 
            'Modifications valid√©es avec succ√®s';
        showSuccessToast(successMessage);
    })
    .catch(error => {
        console.error('Error validating modifications:', error);
        showErrorToast('Erreur lors de la validation: ' + error.message);
    });
}

function rejectModifications() {
    if (!currentValidationRequestId) {
        showErrorToast('Erreur: Aucune demande s√©lectionn√©e');
        return;
    }
    
    // Trouver les demandes li√©es pour informer l'utilisateur
    const currentRequest = window.allRequests.find(req => req.id === currentValidationRequestId);
    if (!currentRequest) {
        showErrorToast('Erreur: Demande non trouv√©e');
        return;
    }
    
    const relatedRequestsWithModifications = window.allRequests.filter(req => 
        req.teacher_id === currentRequest.teacher_id && 
        req.request_name === currentRequest.request_name &&
        requestsWithPendingModifications.has(req.id)
    );
    
    const confirmMessage = relatedRequestsWithModifications.length > 1 ? 
        `√ätes-vous s√ªr de vouloir rejeter les modifications de ${relatedRequestsWithModifications.length} demandes li√©es ? Elles seront d√©finitivement supprim√©es.` :
        '√ätes-vous s√ªr de vouloir rejeter ces modifications ? Elles seront d√©finitivement supprim√©es.';
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Rejeter les modifications pour toutes les demandes li√©es
    const rejectionPromises = relatedRequestsWithModifications.map(req => 
        fetch(`/api/pending-modifications/${req.id}/reject`, {
            method: 'POST'
        }).then(response => response.json())
    );
    
    Promise.all(rejectionPromises)
    .then(results => {
        // V√©rifier s'il y a des erreurs
        const errors = results.filter(result => result.error);
        if (errors.length > 0) {
            throw new Error(`Erreurs lors du rejet: ${errors.map(e => e.error).join(', ')}`);
        }
        
        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('validationModal'));
        modal.hide();
        
        // Nettoyer les Maps locales et mettre √† jour les objets de demandes
        relatedRequestsWithModifications.forEach(req => {
            modifiedRequests.delete(req.id.toString());
            allPendingModifications.delete(req.id);
            requestsWithPendingModifications.delete(req.id);
            
            // Mettre √† jour l'objet de la demande pour refl√©ter que modified = false
            const requestInList = window.allRequests.find(r => r.id === req.id);
            if (requestInList) {
                requestInList.modified = false;
            }
        });
        
        // Rafra√Æchir la liste
        loadRequestsWithPendingModifications();
        loadRequests();
        
        const successMessage = relatedRequestsWithModifications.length > 1 ? 
            `${relatedRequestsWithModifications.length} demandes rejet√©es` : 
            'Modifications rejet√©es';
        showSuccessToast(successMessage);
    })
    .catch(error => {
        console.error('Error rejecting modifications:', error);
        showErrorToast('Erreur lors du rejet: ' + error.message);
    });
}



function deleteRequest() {
    const requestId = document.getElementById('editRequestId').value;
    const teacherName = document.getElementById('editTeacher').selectedOptions[0].text;
    const className = document.getElementById('editClassName').value;
    const date = document.getElementById('editDate').value;
    
    // Confirmation de suppression
    const confirmMessage = `‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer cette demande ?\n\n` +
                          `Enseignant: ${teacherName}\n` +
                          `Classe: ${className}\n` +
                          `Date: ${date}\n\n` +
                          `Cette action est irr√©versible !`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    fetch(`/api/requests/${requestId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Fermer le modal
        const modalElement = document.getElementById('editRequestModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
        
        // Recharger la liste des demandes
        loadRequests();
        showSuccessToast('Demande supprim√©e avec succ√®s');
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Erreur lors de la suppression: ' + error.message);
    });
}

function togglePrepared(requestId) {
    fetch(`/api/requests/${requestId}/toggle-prepared`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        loadRequests();
        showSuccessToast('Statut mis √† jour avec succ√®s');
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorToast('Erreur lors de la mise √† jour du statut');
    });
}

function toggleEditSpecialModes() {
    const isAbsent = document.getElementById('editAbsent').checked;
    const isNoMaterial = document.getElementById('editNoMaterial').checked;
    const isExamMode = document.getElementById('editExamMode').checked;
    const quantitySection = document.getElementById('editQuantitySection');
    const materialSection = document.getElementById('editMaterialSection');
    const materialProfSection = document.getElementById('editMaterialProfSection');
    const materialCheckboxSection = document.getElementById('editMaterialCheckboxSection');
    
    // S'assurer qu'une seule option est coch√©e √† la fois
    let checkedCount = (isAbsent ? 1 : 0) + (isNoMaterial ? 1 : 0) + (isExamMode ? 1 : 0);
    if (checkedCount > 1) {
        const activeElement = document.activeElement;
        if (activeElement === document.getElementById('editAbsent')) {
            document.getElementById('editNoMaterial').checked = false;
            document.getElementById('editExamMode').checked = false;
        } else if (activeElement === document.getElementById('editNoMaterial')) {
            document.getElementById('editAbsent').checked = false;
            document.getElementById('editExamMode').checked = false;
        } else if (activeElement === document.getElementById('editExamMode')) {
            document.getElementById('editAbsent').checked = false;
            document.getElementById('editNoMaterial').checked = false;
        }
    }
    
    const shouldHideSections = isAbsent || isNoMaterial || isExamMode;
    
    if (shouldHideSections) {
        // Hide material-related sections
        if (quantitySection) quantitySection.style.display = 'none';
        if (materialSection) materialSection.style.display = 'none';
        if (materialProfSection) materialProfSection.style.display = 'none';
        if (materialCheckboxSection) materialCheckboxSection.style.display = 'none';
        
        // Remove required attribute
        const editMaterialDescription = document.getElementById('editMaterialDescription');
        if (editMaterialDescription) editMaterialDescription.removeAttribute('required');
    } else {
        // Show material-related sections
        if (quantitySection) quantitySection.style.display = 'block';
        if (materialSection) materialSection.style.display = 'block';
        if (materialProfSection) materialProfSection.style.display = 'block';
        if (materialCheckboxSection) materialCheckboxSection.style.display = 'block';
        
        // Add required attribute back
        const editMaterialDescription = document.getElementById('editMaterialDescription');
        if (editMaterialDescription) editMaterialDescription.setAttribute('required', 'required');
    }
}

// Add event listeners when modal is first shown
document.addEventListener('DOMContentLoaded', function() {
    const editAbsentCheckbox = document.getElementById('editAbsent');
    const editNoMaterialCheckbox = document.getElementById('editNoMaterial');
    const editExamModeCheckbox = document.getElementById('editExamMode');
    if (editAbsentCheckbox) {
        editAbsentCheckbox.addEventListener('change', toggleEditSpecialModes);
    }
    if (editNoMaterialCheckbox) {
        editNoMaterialCheckbox.addEventListener('change', toggleEditSpecialModes);
    }
    if (editExamModeCheckbox) {
        editExamModeCheckbox.addEventListener('change', toggleEditSpecialModes);
    }
});

// Toast functions (using base.html toast if available)
function showSuccessToast(message) {
    if (typeof window.showToast === 'function') {
        window.showToast('success', 'Succ√®s', message);
    } else {
        alert(message);
    }
}

function showErrorToast(message) {
    if (typeof window.showToast === 'function') {
        window.showToast('error', 'Erreur', message);
    } else {
        alert(message);
    }
}

// Fonction pour afficher une image dans un modal
function showImageModal(imageUrl, title) {
    // Cr√©er ou r√©utiliser le modal d'image
    let imageModal = document.getElementById('imageModal');
    if (!imageModal) {
        // Cr√©er le modal s'il n'existe pas
        imageModal = document.createElement('div');
        imageModal.id = 'imageModal';
        imageModal.className = 'modal fade';
        imageModal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalTitle">Image</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="imageModalImg" src="" alt="Image" class="img-fluid">
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(imageModal);
    }
    
    // Mettre √† jour le contenu du modal
    document.getElementById('imageModalTitle').textContent = title || 'Image';
    document.getElementById('imageModalImg').src = imageUrl;
    
    // Afficher le modal
    const modal = new bootstrap.Modal(imageModal);
    modal.show();
    // Correction accessibilit√© : retirer aria-hidden
    imageModal.removeAttribute('aria-hidden');
}

// Toggle entre vue normale et vue group√©e

</script>

<!-- Modal pour afficher les images en grand -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imageModalImg" src="" alt="Image" class="img-fluid">
            </div>
        </div>
    </div>
</div>

{% endblock %}