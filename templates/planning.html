{% extends "base.html" %}
{% block title %}G√©n√©rateur de Planning{% endblock %}

{% block extra_css %}
<style>
.planning-day-view {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.teacher-group {
    margin-bottom: 1.5rem;
}

.teacher-name {
    font-weight: bold;
    color: #495057;
    margin-bottom: 0.75rem;
    padding-left: 1rem;
    border-left: 4px solid #007bff;
    font-size: 1.1rem;
}

.planning-request {
    color: white;
    padding: 1rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
    cursor: pointer;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.planning-request:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.request-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.request-time {
    font-weight: bold;
    font-size: 1rem;
}

.request-class {
    font-weight: 600;
    margin-left: auto;
}

.request-details {
    font-size: 0.85rem;
    opacity: 0.9;
}

.room-type-selector {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 4px;
    color: white;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    margin-top: 0.5rem;
}

.room-type-selector:focus {
    background: rgba(255,255,255,0.3);
    border-color: rgba(255,255,255,0.5);
    color: white;
}

.room-type-selector option {
    background: #333;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>G√©n√©rateur de Planning</h2>
    <form id="planningForm" class="mb-3">
        <div class="row">
            <div class="col-md-6">
                <label for="planningDate" class="form-label">S√©lectionnez une date :</label>
                <input type="date" id="planningDate" name="planningDate" class="form-control" required 
                       pattern="\d{4}-\d{2}-\d{2}" placeholder="jj/mm/aaaa">
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button type="button" id="generatePlanningBtn" class="btn btn-primary" disabled onclick="generatePlanning()">
                    <i class="fas fa-file-excel"></i> G√©n√©rer Planning Excel
                </button>
                <div id="planningSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                    <span class="visually-hidden">G√©n√©ration en cours...</span>
                </div>
            </div>
        </div>
    </form>
    
    <!-- Messages d'√©tat -->
    <div id="planningMessage" class="alert d-none" role="alert"></div>
    
    <!-- L√©gende des couleurs -->
    <div class="row mb-4" id="planningLegend" style="display: none;">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-header bg-transparent border-0 py-2">
                    <h6 class="mb-0">üé® L√©gende des couleurs</h6>
                </div>
                <div class="card-body py-2">
                    <div class="row text-center">
                        <div class="col-md-2 col-6 mb-2">
                            <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #007bff; color: white; border-radius: 8px; font-size: 0.75rem;">
                                <span class="me-2">üîµ</span>
                                <span>Demande normale</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-2">
                            <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #28a745; color: white; border-radius: 8px; font-size: 0.75rem;">
                                <span class="me-2">‚úÖ</span>
                                <span>Pr√©par√©e</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-6 mb-2">
                            <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #ffc107; color: #212529; border-radius: 8px; font-size: 0.75rem;">
                                <span class="me-2">‚ö†Ô∏è</span>
                                <span>Modifi√©e</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-2">
                            <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #dc3545; color: white; border-radius: 8px; font-size: 0.75rem;">
                                <span class="me-2">‚ùå</span>
                                <span>Enseignant absent</span>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-2">
                            <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #20c997; color: white; border-radius: 8px; font-size: 0.75rem;">
                                <span class="me-2">üìö</span>
                                <span>Pas besoin de mat√©riel</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="planningResults">
        <div id="planningDay" class="planning-day-view" style="display: none;">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" id="planningDayTitle">üìÖ Planning du jour</h5>
                </div>
                <div class="card-body">
                    <div id="planningByTeacher">
                        <!-- Les demandes group√©es par enseignant seront affich√©es ici -->
                    </div>
                </div>
            </div>
        </div>
        <div id="noPlanningResults" class="alert alert-info d-none">Aucune demande pour ce jour.</div>
    </div>
</div>
<script>
document.getElementById('planningDate').addEventListener('change', function() {
    const date = this.value;
    const generateBtn = document.getElementById('generatePlanningBtn');
    
    // Activer/d√©sactiver le bouton de g√©n√©ration
    generateBtn.disabled = !date;
    
    if (!date) {
        document.getElementById('planningDay').style.display = 'none';
        document.getElementById('planningLegend').style.display = 'none';
        return;
    }
    
    // Mettre √† jour le titre avec la date
    const dateObj = new Date(date + 'T00:00:00'); // Forcer le fuseau horaire local
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    const formattedDate = dateObj.toLocaleDateString('fr-FR', options);
    document.getElementById('planningDayTitle').textContent = `üìÖ Planning du ${formattedDate}`;
    
    fetch(`/api/requests?start_date=${date}&end_date=${date}`)
        .then(response => response.json())
        .then(requests => {
            const planningContainer = document.getElementById('planningByTeacher');
            const noResults = document.getElementById('noPlanningResults');
            const planningDay = document.getElementById('planningDay');
            const planningLegend = document.getElementById('planningLegend');
            
            planningContainer.innerHTML = '';
            
            if (requests.length === 0) {
                noResults.classList.remove('d-none');
                planningDay.style.display = 'none';
                planningLegend.style.display = 'none';
                return;
            }
            
            noResults.classList.add('d-none');
            planningDay.style.display = 'block';
            planningLegend.style.display = 'block';
            
            // Grouper les demandes par enseignant
            const requestsByTeacher = {};
            requests.forEach(request => {
                if (!requestsByTeacher[request.teacher_name]) {
                    requestsByTeacher[request.teacher_name] = [];
                }
                requestsByTeacher[request.teacher_name].push(request);
            });
            
            // Cr√©er l'affichage pour chaque enseignant
            Object.keys(requestsByTeacher).sort().forEach(teacherName => {
                const teacherGroup = document.createElement('div');
                teacherGroup.className = 'teacher-group';
                
                const teacherHeader = document.createElement('div');
                teacherHeader.className = 'teacher-name';
                teacherHeader.textContent = teacherName;
                teacherGroup.appendChild(teacherHeader);
                
                // Trier les demandes par horaire avant affichage
                const sortedRequests = requestsByTeacher[teacherName].sort((a, b) => {
                    const timeA = a.horaire || '';
                    const timeB = b.horaire || '';
                    
                    // Si pas d'horaire, mettre √† la fin
                    if (!timeA && !timeB) return 0;
                    if (!timeA) return 1;
                    if (!timeB) return -1;
                    
                    // Convertir les horaires en minutes pour comparaison
                    const parseTime = (time) => {
                        const match = time.match(/(\d+)h(\d*)/);
                        if (match) {
                            const hours = parseInt(match[1]);
                            const minutes = match[2] ? parseInt(match[2]) : 0;
                            return hours * 60 + minutes;
                        }
                        return 0;
                    };
                    
                    return parseTime(timeA) - parseTime(timeB);
                });
                
                sortedRequests.forEach(request => {
                    const requestElement = createPlanningRequestElement(request);
                    teacherGroup.appendChild(requestElement);
                });
                
                planningContainer.appendChild(teacherGroup);
            });
        })
        .catch(error => {
            console.error('Error loading requests:', error);
            document.getElementById('noPlanningResults').classList.remove('d-none');
            document.getElementById('planningDay').style.display = 'none';
            document.getElementById('planningLegend').style.display = 'none';
        });
});

function createPlanningRequestElement(request) {
    const requestDiv = document.createElement('div');
    requestDiv.className = 'planning-request';
    
    // D√©terminer la couleur de fond selon le statut
    let bgColor = '#007bff'; // Bleu par d√©faut (demande normale)
    
    if (request.selected_materials === 'Absent') {
        bgColor = '#dc3545'; // Rouge pour absent
    } else if (request.selected_materials === 'Pas besoin de mat√©riel') {
        bgColor = '#20c997'; // Vert clair pour pas besoin de mat√©riel (NOUVELLE COULEUR)
    } else if (request.prepared) {
        bgColor = '#28a745'; // Vert fonc√© pour pr√©par√©
    } else if (request.modified) {
        bgColor = '#ffc107'; // Jaune pour modifi√©
    }
    
    console.log(`Demande ${request.id}: ${request.selected_materials} ‚Üí Couleur: ${bgColor}`);
    
    requestDiv.style.backgroundColor = bgColor;
    
    const roomType = request.room_type || 'Mixte';
    
    requestDiv.innerHTML = `
        <div class="request-header">
            <span class="request-time">üïí ${request.horaire || 'Non sp√©cifi√©'}</span>
            <span class="request-class">${request.class_name}</span>
        </div>
        <div class="request-details">
            <div><strong>Mat√©riel:</strong> ${request.material_description}</div>
            <div><strong>Quantit√©:</strong> ${request.quantity || 1}</div>
            ${request.computers_needed ? `<div><strong>Ordinateurs:</strong> ${request.computers_needed}</div>` : ''}
            ${request.notes ? `<div><strong>Notes:</strong> ${request.notes}</div>` : ''}
        </div>
        <select class="room-type-selector" onchange="updateRoomType(${request.id}, this.value)">
            <option value="Mixte" ${roomType === 'Mixte' ? 'selected' : ''}>üî¨ Salle Mixte</option>
            <option value="Physique" ${roomType === 'Physique' ? 'selected' : ''}>‚öõÔ∏è Salle Physique</option>
            <option value="Chimie" ${roomType === 'Chimie' ? 'selected' : ''}>üß™ Salle Chimie</option>
        </select>
    `;
    
    return requestDiv;
}

function updateRoomType(requestId, roomType) {
    fetch(`/api/requests/${requestId}/room-type`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({room_type: roomType})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erreur: ' + data.error);
            // Recharger la page pour restaurer l'ancienne valeur
            location.reload();
        } else {
            console.log('Type de salle mis √† jour:', roomType);
            // Optionnel: afficher un message de succ√®s
            if (typeof window.showToast === 'function') {
                window.showToast('success', 'Succ√®s', 'Type de salle mis √† jour');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise √† jour du type de salle');
        location.reload();
    });
}

function generatePlanning() {
    const date = document.getElementById('planningDate').value;
    if (!date) {
        showMessage('Veuillez s√©lectionner une date', 'warning');
        return;
    }

    const spinner = document.getElementById('planningSpinner');
    const btn = document.getElementById('generatePlanningBtn');
    const originalBtnText = btn.innerHTML;

    // Afficher le spinner et d√©sactiver le bouton
    spinner.classList.remove('d-none');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';

    fetch('/api/generate-planning', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({date: date})
    })
    .then(async (response) => {
        if (!response.ok) {
            let errMsg = 'Erreur lors de la g√©n√©ration';
            try {
                const err = await response.json();
                if (err && err.error) errMsg = err.error;
            } catch (_) {}
            throw new Error(errMsg);
        }

        // D√©clencher le t√©l√©chargement du fichier Excel
        const disposition = response.headers.get('Content-Disposition') || '';
        let filename = 'planning.xlsx';
        const match = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/i.exec(disposition);
        if (match && match[1]) {
            filename = match[1].replace(/["']/g, '');
        } else {
            // Fallback: g√©n√©rer un nom √† partir de la date s√©lectionn√©e
            try {
                const d = new Date(date + 'T00:00:00');
                const jours = ['LUNDI','MARDI','MERCREDI','JEUDI','VENDREDI','SAMEDI','DIMANCHE'];
                const jour = jours[d.getDay() === 0 ? 6 : d.getDay() - 1]; // adapter √† Lundi=0
                const formatted = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
                filename = `planning_${jour}_${formatted}.xlsx`;
            } catch (_) {}
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        // Ensuite, sauvegarder le planning c√¥t√© serveur (donn√©es √† compl√©ter si n√©cessaire)
        return fetch('/api/save-planning', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({date: date, data: {}})
        });
    })
    .then(saveResponse => {
        if (!saveResponse.ok) {
            return saveResponse.json().then(err => {
                throw new Error(err.error || 'Erreur lors de la sauvegarde du planning');
            });
        }

        showMessage('Planning g√©n√©r√©, t√©l√©charg√© et sauvegard√© avec succ√®s', 'success');
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage(error.message || 'Erreur lors de la g√©n√©ration ou de la sauvegarde du planning', 'danger');
    })
    .finally(() => {
        // Restaurer le bouton
        spinner.classList.add('d-none');
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    });
}

function showMessage(message, type) {
    const messageDiv = document.getElementById('planningMessage');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.textContent = message;
    messageDiv.classList.remove('d-none');
    
    // Masquer le message apr√®s 5 secondes
    setTimeout(() => {
        messageDiv.classList.add('d-none');
    }, 5000);
}

// D√©finir la date par d√©faut au prochain jour ouvrable
function setDefaultDate() {
    const today = new Date();
    let nextWorkDay = new Date(today);
    
    // Ajouter 1 jour par d√©faut
    nextWorkDay.setDate(today.getDate() + 1);
    
    // Si on est vendredi (5), samedi (6) ou dimanche (0), aller au lundi suivant
    const dayOfWeek = today.getDay();
    if (dayOfWeek === 5) { // Vendredi -> Lundi (+ 3 jours)
        nextWorkDay.setDate(today.getDate() + 3);
    } else if (dayOfWeek === 6) { // Samedi -> Lundi (+ 2 jours)
        nextWorkDay.setDate(today.getDate() + 2);
    } else if (dayOfWeek === 0) { // Dimanche -> Lundi (+ 1 jour)
        nextWorkDay.setDate(today.getDate() + 1);
    }
    
    // Formater la date au format YYYY-MM-DD
    const dateString = nextWorkDay.toISOString().split('T')[0];
    document.getElementById('planningDate').value = dateString;
    
    // D√©clencher l'√©v√©nement change pour charger les demandes
    document.getElementById('planningDate').dispatchEvent(new Event('change'));
}

// Initialiser la date au chargement de la page
document.addEventListener('DOMContentLoaded', setDefaultDate);
</script>
{% endblock %}
