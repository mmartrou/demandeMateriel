{% extends "base.html" %}
{% block title %}G√©n√©rateur de Planning{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>G√©n√©rateur de Planning</h2>
    <form id="planningForm" class="mb-3">
        <div class="row">
            <div class="col-md-6">
                <label for="planningDate" class="form-label">S√©lectionnez une date :</label>
                <input type="date" id="planningDate" name="planningDate" class="form-control" required>
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button type="button" id="generatePlanningBtn" class="btn btn-primary" disabled onclick="generatePlanning()">
                    <i class="fas fa-file-excel"></i> G√©n√©rer Planning Excel
                </button>
                <div id="planningSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                    <span class="visually-hidden">G√©n√©ration en cours...</span>
                </div>
            </div>
        </div>
    </form>
    
    <!-- Messages d'√©tat -->
    <div id="planningMessage" class="alert d-none" role="alert"></div>
    
    <div id="planningResults">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Enseignant</th>
                    <th>Classe</th>
                    <th>Mat√©riel</th>
                    <th>Quantit√©</th>
                    <th>Type de salle</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody id="planningTableBody">
                <!-- Les demandes du jour seront ins√©r√©es ici -->
            </tbody>
        </table>
        <div id="noPlanningResults" class="alert alert-info d-none">Aucune demande pour ce jour.</div>
    </div>
</div>
<script>
document.getElementById('planningDate').addEventListener('change', function() {
    const date = this.value;
    const generateBtn = document.getElementById('generatePlanningBtn');
    
    // Activer/d√©sactiver le bouton de g√©n√©ration
    generateBtn.disabled = !date;
    
    if (!date) return;
    fetch(`/api/requests?start_date=${date}&end_date=${date}`)
        .then(response => response.json())
        .then(requests => {
            const tableBody = document.getElementById('planningTableBody');
            const noResults = document.getElementById('noPlanningResults');
            tableBody.innerHTML = '';
            if (requests.length === 0) {
                noResults.classList.remove('d-none');
                return;
            }
            noResults.classList.add('d-none');
            requests.forEach(request => {
                const row = document.createElement('tr');
                const roomType = request.room_type || 'Mixte';
                row.innerHTML = `
                    <td>${request.teacher_name}</td>
                    <td>${request.class_name}</td>
                    <td>${request.material_description}</td>
                    <td>${request.quantity}</td>
                    <td>
                        <select class="form-select form-select-sm" onchange="updateRoomType(${request.id}, this.value)">
                            <option value="Mixte" ${roomType === 'Mixte' ? 'selected' : ''}>üî¨ Mixte</option>
                            <option value="Physique" ${roomType === 'Physique' ? 'selected' : ''}>‚öõÔ∏è Physique</option>
                            <option value="Chimie" ${roomType === 'Chimie' ? 'selected' : ''}>üß™ Chimie</option>
                        </select>
                    </td>
                    <td>${request.notes || '<em class="text-muted">Aucune</em>'}</td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            tableBody.innerHTML = '';
            noResults.classList.remove('d-none');
        });
});

function updateRoomType(requestId, roomType) {
    fetch(`/api/requests/${requestId}/room-type`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({room_type: roomType})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erreur: ' + data.error);
            // Recharger la page pour restaurer l'ancienne valeur
            location.reload();
        } else {
            console.log('Type de salle mis √† jour:', roomType);
            // Optionnel: afficher un message de succ√®s
            if (typeof window.showToast === 'function') {
                window.showToast('success', 'Succ√®s', 'Type de salle mis √† jour');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise √† jour du type de salle');
        location.reload();
    });
}

function generatePlanning() {
    const date = document.getElementById('planningDate').value;
    if (!date) {
        showMessage('Veuillez s√©lectionner une date', 'warning');
        return;
    }
    
    const spinner = document.getElementById('planningSpinner');
    const btn = document.getElementById('generatePlanningBtn');
    const originalBtnText = btn.innerHTML;
    
    // Afficher le spinner et d√©sactiver le bouton
    spinner.classList.remove('d-none');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';
    
    fetch('/api/generate-planning', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({date: date})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Planning g√©n√©r√© avec succ√®s: ${data.filename}`, 'success');
        } else {
            showMessage(data.error || 'Erreur lors de la g√©n√©ration', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Erreur lors de la g√©n√©ration du planning', 'danger');
    })
    .finally(() => {
        // Restaurer le bouton
        spinner.classList.add('d-none');
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    });
}

function showMessage(message, type) {
    const messageDiv = document.getElementById('planningMessage');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.textContent = message;
    messageDiv.classList.remove('d-none');
    
    // Masquer le message apr√®s 5 secondes
    setTimeout(() => {
        messageDiv.classList.add('d-none');
    }, 5000);
}

// D√©finir la date par d√©faut au prochain jour ouvrable
function setDefaultDate() {
    const today = new Date();
    let nextWorkDay = new Date(today);
    
    // Ajouter 1 jour par d√©faut
    nextWorkDay.setDate(today.getDate() + 1);
    
    // Si on est vendredi (5), samedi (6) ou dimanche (0), aller au lundi suivant
    const dayOfWeek = today.getDay();
    if (dayOfWeek === 5) { // Vendredi -> Lundi (+ 3 jours)
        nextWorkDay.setDate(today.getDate() + 3);
    } else if (dayOfWeek === 6) { // Samedi -> Lundi (+ 2 jours)
        nextWorkDay.setDate(today.getDate() + 2);
    } else if (dayOfWeek === 0) { // Dimanche -> Lundi (+ 1 jour)
        nextWorkDay.setDate(today.getDate() + 1);
    }
    
    // Formater la date au format YYYY-MM-DD
    const dateString = nextWorkDay.toISOString().split('T')[0];
    document.getElementById('planningDate').value = dateString;
    
    // D√©clencher l'√©v√©nement change pour charger les demandes
    document.getElementById('planningDate').dispatchEvent(new Event('change'));
}

// Initialiser la date au chargement de la page
document.addEventListener('DOMContentLoaded', setDefaultDate);
</script>
{% endblock %}
