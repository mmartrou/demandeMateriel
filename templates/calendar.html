{% extends "base.html" %}

{% block extra_css %}
<style>
.calendar-container {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.calendar-header {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.week-view {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
}

.week-day {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
}

.week-day-header {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
    color: #495057;
}

.week-day-events {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.teacher-group {
    margin-bottom: 1rem;
}

.teacher-name {
    font-weight: bold;
    color: #6c757d;
    margin-bottom: 0.5rem;
    padding-left: 0.5rem;
    border-left: 3px solid #007bff;
}

.calendar-event {
    color: white !important;
    padding: 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.85rem;
    cursor: pointer;
    margin-bottom: 0.25rem;
    transition: background-color 0.2s;
    /* La couleur de fond sera définie par le JavaScript avec !important */
}

.calendar-event:hover {
    background-color: #0056b3;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    🗓️ Planning Hebdomadaire - Demandes de Matériel
                </h4>
                <div>
                    <button class="btn btn-light btn-sm me-2" onclick="loadCalendar()">
                        🔄 Actualiser
                    </button>
                    <a href="/requests" class="btn btn-light btn-sm">
                        📋 Liste des demandes
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Filtres -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="calendarFilterTeacher" class="form-label">👨‍🏫 Enseignant</label>
                        <select class="form-select" id="calendarFilterTeacher">
                            <option value="">Tous les enseignants</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="calendarFilterStatus" class="form-label">📊 Statut</label>
                        <select class="form-select" id="calendarFilterStatus">
                            <option value="">Tous</option>
                            <option value="prepared">Préparées</option>
                            <option value="modified">Modifiées</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="calendarFilterType" class="form-label">📝 Type</label>
                        <select class="form-select" id="calendarFilterType">
                            <option value="">Tous</option>
                            <option value="normal">Demandes normales</option>
                            <option value="absent">Absences</option>
                            <option value="no-material">Pas besoin de matériel</option>
                        </select>
                    </div>
                </div>
                
                <!-- Légende des couleurs -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 bg-light">
                            <div class="card-header bg-transparent border-0 py-2">
                                <h6 class="mb-0">🎨 Légende des couleurs</h6>
                            </div>
                            <div class="card-body py-2">
                                <div class="row text-center">
                                    <div class="col-md-2 col-6 mb-2">
                                        <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #007bff; color: white; border-radius: 8px; font-size: 0.75rem;">
                                            <span class="me-2">🔵</span>
                                            <span>Demande normale</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-6 mb-2">
                                        <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #28a745; color: white; border-radius: 8px; font-size: 0.75rem;">
                                            <span class="me-2">✅</span>
                                            <span>Préparée</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-6 mb-2">
                                        <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #ffc107; color: #212529; border-radius: 8px; font-size: 0.75rem;">
                                            <span class="me-2">⚠️</span>
                                            <span>Modifiée</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-2">
                                        <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #dc3545; color: white; border-radius: 8px; font-size: 0.75rem;">
                                            <span class="me-2">❌</span>
                                            <span>Enseignant absent</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6 mb-2">
                                        <div class="badge d-flex align-items-center justify-content-center py-2 px-3" style="background-color: #20c997; color: white; border-radius: 8px; font-size: 0.75rem;">
                                            <span class="me-2">📚</span>
                                            <span>Pas besoin de matériel</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vue semaine -->
                <div class="row">
                    <div class="col-12">
                        <div class="week-calendar">
                            <div class="calendar-header text-center mb-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="previousWeek()">‹ Semaine précédente</button>
                                <h5 id="currentWeek" class="d-inline mx-4 mb-0"></h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="nextWeek()">Semaine suivante ›</button>
                            </div>
                            <div class="week-view" id="weekView">
                                <!-- Week view will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="eventModalLabel">
                    📝 Détails de la demande
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer la modal"></button>
            </div>
            <div class="modal-body">
                <div id="eventDetails" role="document">
                    <!-- Event details will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentWeekStart = getStartOfWeek(new Date());
let events = [];

function getStartOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
    return new Date(d.setDate(diff));
}

function getWeekDays(startDate) {
    const days = [];
    for (let i = 0; i < 5; i++) { // Only Monday to Friday
        const day = new Date(startDate);
        day.setDate(startDate.getDate() + i);
        days.push(day);
    }
    return days;
}

// Gestion des cookies
function setCookie(name, value, days = 30) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
}

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

document.addEventListener('DOMContentLoaded', function() {
    // Load teachers for filter
    fetch('/api/teachers')
        .then(response => response.json())
        .then(teachers => {
            const teacherFilter = document.getElementById('calendarFilterTeacher');
            teacherFilter.innerHTML = '<option value="">Tous les enseignants</option>';
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                teacherFilter.appendChild(option);
            });
            
            // Restore selected teacher from cookie
            const savedTeacher = getCookie('selectedTeacher');
            if (savedTeacher) {
                teacherFilter.value = savedTeacher;
            }
            
            // Load calendar after teacher filter is restored
            loadCalendar();
        });
    
    // Set up filter change handlers
    document.getElementById('calendarFilterTeacher').addEventListener('change', loadCalendar);
    document.getElementById('calendarFilterStatus').addEventListener('change', loadCalendar);
    document.getElementById('calendarFilterType').addEventListener('change', loadCalendar);
    
    // Save teacher selection to cookie
    document.getElementById('calendarFilterTeacher').addEventListener('change', function() {
        if (this.value) {
            setCookie('selectedTeacher', this.value);
        }
    });
});

function loadCalendar() {
    // Get filter values
    const teacherId = document.getElementById('calendarFilterTeacher').value;
    const statusFilter = document.getElementById('calendarFilterStatus').value;
    const typeFilter = document.getElementById('calendarFilterType').value;
    
    // Build query string
    const params = new URLSearchParams();
    if (teacherId) params.append('teacher_id', teacherId);
    if (statusFilter) params.append('status', statusFilter);
    if (typeFilter) params.append('type', typeFilter);
    
    // Load events from API with filters
    fetch(`/api/calendar-events?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            console.log('Calendar events reçus:', data);
            // Afficher le format de la première date si disponible
            if (data.length > 0) {
                console.log('Format de date exemple:', data[0].start, 'Type:', typeof data[0].start);
            }
            events = data;
            renderWeekView();
        })
        .catch(error => {
            console.error('Error loading events:', error);
        });
}

// Fonction pour normaliser les dates en format YYYY-MM-DD
function normalizeDateToYMD(dateValue) {
    if (!dateValue) return null;
    
    let date;
    
    // Si c'est déjà une chaîne au format YYYY-MM-DD
    if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
        return dateValue;
    }
    
    // Si c'est une chaîne de date GMT ou autre format
    if (typeof dateValue === 'string') {
        date = new Date(dateValue);
    } 
    // Si c'est déjà un objet Date
    else if (dateValue instanceof Date) {
        date = dateValue;
    }
    // Sinon, essayer de le convertir
    else {
        date = new Date(dateValue);
    }
    
    // Vérifier si la date est valide
    if (isNaN(date.getTime())) {
        console.error('Date invalide:', dateValue);
        return null;
    }
    
    // Retourner au format YYYY-MM-DD
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function renderWeekView() {
    const weekDays = getWeekDays(currentWeekStart);
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 4); // Friday
    
    // Update week header
    const monthNames = [
        'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
        'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
    ];
    
    const startStr = `${currentWeekStart.getDate()} ${monthNames[currentWeekStart.getMonth()]}`;
    const endStr = `${weekEnd.getDate()} ${monthNames[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;
    document.getElementById('currentWeek').textContent = `Semaine du ${startStr} au ${endStr}`;
    
    // Generate week view
    const weekView = document.getElementById('weekView');
    weekView.innerHTML = '';
    
    const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
    const teacherId = document.getElementById('calendarFilterTeacher').value;
    
    weekDays.forEach((day, index) => {
        const dayElement = document.createElement('div');
        dayElement.className = 'week-day';
        
        // Day header
        const dayHeader = document.createElement('div');
        dayHeader.className = 'week-day-header';
        dayHeader.textContent = `${dayNames[index]} ${day.getDate()}/${day.getMonth() + 1}`;
        dayElement.appendChild(dayHeader);
        
        // Day events container
        const dayEventsContainer = document.createElement('div');
        dayEventsContainer.className = 'week-day-events';
        
        // Get events for this day - normaliser les dates pour la comparaison
        const dayDate = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}-${String(day.getDate()).padStart(2, '0')}`;
        const dayEvents = events.filter(event => {
            const eventDate = normalizeDateToYMD(event.start);
            return eventDate === dayDate;
        });
        
        if (dayEvents.length === 0) {
            const noEvents = document.createElement('div');
            noEvents.className = 'text-muted text-center py-3';
            noEvents.textContent = 'Aucune demande';
            dayEventsContainer.appendChild(noEvents);
        } else {
            // Group events by teacher if all teachers are shown
            if (!teacherId) {
                const eventsByTeacher = {};
                dayEvents.forEach(event => {
                    const teacherName = event.title.split(' - ')[0];
                    if (!eventsByTeacher[teacherName]) {
                        eventsByTeacher[teacherName] = [];
                    }
                    eventsByTeacher[teacherName].push(event);
                });
                
                Object.keys(eventsByTeacher).forEach(teacherName => {
                    const teacherGroup = document.createElement('div');
                    teacherGroup.className = 'teacher-group';
                    
                    const teacherHeader = document.createElement('div');
                    teacherHeader.className = 'teacher-name';
                    teacherHeader.textContent = teacherName;
                    teacherGroup.appendChild(teacherHeader);
                    
                    eventsByTeacher[teacherName].forEach(event => {
                        const eventElement = createEventElement(event);
                        teacherGroup.appendChild(eventElement);
                    });
                    
                    dayEventsContainer.appendChild(teacherGroup);
                });
            } else {
                // Show all events for selected teacher
                dayEvents.forEach(event => {
                    const eventElement = createEventElement(event);
                    dayEventsContainer.appendChild(eventElement);
                });
            }
        }
        
        dayElement.appendChild(dayEventsContainer);
        weekView.appendChild(dayElement);
    });
}

function createEventElement(event) {
    const eventElement = document.createElement('div');
    eventElement.className = 'calendar-event';
    const bgColor = event.backgroundColor || '#007bff';
    console.log(`DEBUG FRONTEND - Event ID: ${event.id}, backgroundColor reçu: ${event.backgroundColor}, couleur finale: ${bgColor}`);
    eventElement.style.setProperty('background-color', bgColor, 'important');
    
    // Attributs d'accessibilité
    eventElement.setAttribute('role', 'button');
    eventElement.setAttribute('tabindex', '0');
    eventElement.setAttribute('aria-label', `Détails de la demande: ${event.title}. ${event.description}`);
    
    const className = event.title.split(' - ')[1] || '';
    eventElement.innerHTML = `
        <div><strong>${className}</strong></div>
        <div class="small">${event.description.replace('Matériel: ', '')}</div>
    `;
    
    // Support clavier et souris
    eventElement.onclick = () => showEventDetails(event);
    eventElement.onkeydown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showEventDetails(event);
        }
    };
    
    return eventElement;
}

function previousWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderWeekView();
}

function nextWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderWeekView();
}

function showEventDetails(event) {
    const modalElement = document.getElementById('eventModal');
    const modal = new bootstrap.Modal(modalElement);
    const details = document.getElementById('eventDetails');
    
    details.innerHTML = `
        <div class="row">
            <div class="col-sm-4"><strong>Enseignant:</strong></div>
            <div class="col-sm-8">${event.title.split(' - ')[0]}</div>
        </div>
        <div class="row mt-2">
            <div class="col-sm-4"><strong>Classe:</strong></div>
            <div class="col-sm-8">${event.title.split(' - ')[1]}</div>
        </div>
        <div class="row mt-2">
            <div class="col-sm-4"><strong>Date:</strong></div>
            <div class="col-sm-8">${formatDate(event.start)}</div>
        </div>
        <div class="row mt-2">
            <div class="col-sm-4"><strong>Description:</strong></div>
            <div class="col-sm-8">${event.description}</div>
        </div>
    `;
    
    // Écouter les événements d'ouverture/fermeture pour l'accessibilité
    modalElement.addEventListener('shown.bs.modal', function () {
        // Focus sur le premier élément focusable dans la modal
        const firstFocusableElement = modalElement.querySelector('button[data-bs-dismiss], .btn-close');
        if (firstFocusableElement) {
            firstFocusableElement.focus();
        }
    });
    
    modalElement.addEventListener('hidden.bs.modal', function () {
        // Remettre le focus sur l'élément qui a ouvert la modal si possible
        const activeElement = document.querySelector('.calendar-event:focus');
        if (activeElement) {
            activeElement.focus();
        }
    });
    
    modal.show();
}

function formatDate(dateString) {
    // Utiliser la normalisation pour gérer tous les formats
    const normalizedDate = normalizeDateToYMD(dateString);
    if (!normalizedDate) return 'Date invalide';
    
    const [year, month, day] = normalizedDate.split('-');
    return `${day}/${month}/${year}`;
}

// Toast functions 
function showSuccessToast(message) {
    if (typeof window.showToast === 'function') {
        window.showToast('success', 'Succès', message);
    } else {
        alert(message);
    }
}

function showErrorToast(message) {
    if (typeof window.showToast === 'function') {
        window.showToast('error', 'Erreur', message);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}