{% extends "base.html" %}

{% block title %}√âditeur de Planning Interactive{% endblock %}

{% block extra_css %}
<style>
    .planning-editor {
        max-width: 100%;
        overflow-x: auto;
    }
    
    /* Layout type Excel avec CSS Grid */
    .planning-grid {
        display: grid;
        grid-template-columns: 80px repeat(9, minmax(100px, 1fr));
        gap: 1px;
        width: 100%;
        font-size: 0.85em;
        margin: 20px 0;
        background-color: #dee2e6;
        min-width: 800px;
    }
    
    .grid-header {
        display: contents;
    }
    
    .time-header {
        background: #6c757d;
        color: white;
        text-align: center;
        padding: 12px 8px;
        font-weight: bold;
        border: 1px solid #dee2e6;
        position: sticky;
        left: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .room-header-cell {
        background: #007bff;
        color: white;
        text-align: center;
        padding: 12px 4px;
        font-weight: bold;
        border: 1px solid #dee2e6;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .grid-row {
        display: contents;
    }
    
    .time-cell {
        background: #f8f9fa;
        text-align: center;
        padding: 8px;
        font-weight: bold;
        border: 1px solid #dee2e6;
        position: sticky;
        left: 0;
        z-index: 5;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .room-cell {
        border: 1px solid #dee2e6;
        padding: 2px;
        min-height: 80px;
        background: #fff;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .room-cell > .course-card {
        display: block !important;
        margin-bottom: 2px;
    }
    
    .room-column {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        min-height: 400px;
        display: none; /* Masquer l'ancien layout */
    }
    
    .room-header {
        background-color: #007bff;
        color: white;
        padding: 15px;
        border-radius: 6px 6px 0 0;
        font-weight: bold;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .room-content {
        padding: 15px;
        min-height: 350px;
    }
    
    .time-slot-group {
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        background-color: white;
    }
    
    .time-slot-header {
        background-color: #e9ecef;
        padding: 8px 12px;
        font-weight: bold;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
    }
    
    .time-slot-courses {
        padding: 10px;
        min-height: 60px;
    }
    
    .course-card {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border-radius: 4px;
        padding: 3px 4px;
        margin: 1px;
        cursor: move;
        font-size: 0.75em;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        min-height: 35px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
        line-height: 1.1;
        width: 100%;
        box-sizing: border-box;
    }
    
    .course-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .course-card.dragging {
        opacity: 0.6;
        transform: rotate(5deg);
        z-index: 1000;
    }
    
    .course-card .course-title {
        font-weight: bold;
        margin-bottom: 1px;
        font-size: 0.85em;
        line-height: 1;
    }
    
    .course-card .course-level {
        font-size: 0.75em;
        opacity: 0.9;
        line-height: 1;
    }
    
    .course-card .course-teacher {
        font-size: 0.7em;
        opacity: 0.8;
        margin-top: 1px;
        line-height: 1;
    }
    
    .course-card.physics {
        background: linear-gradient(135deg, #28a745, #1e7e34);
    }
    
    .course-card.chemistry {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }
    
    .course-card.other {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        color: #212529;
    }
    
    .drop-zone {
        min-height: 60px;
        background-color: transparent;
        border: 1px dashed #dee2e6;
        border-radius: 4px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        padding: 5px;
        transition: all 0.3s ease;
    }
    
    /* S'assurer que les cellules vides sont visibles */
    .room-cell.drop-zone {
        min-height: 80px !important;
        border: 2px solid #007bff !important;
        background-color: #e3f2fd !important;
    }
    

    
    /* D√©filement horizontal pour les √©crans √©troits */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        max-width: 100%;
    }
    
    .table-responsive .planning-grid {
        margin-bottom: 0;
    }
    
    .drop-zone.drag-over {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
    
    .drop-zone:empty::before {
        content: "Glisser un cours ici";
        color: #6c757d;
        font-style: italic;
        align-self: center;
        width: 100%;
        text-align: center;
    }
    
    .stats-panel {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .stat-item {
        display: inline-block;
        margin-right: 20px;
        padding: 8px 12px;
        background-color: white;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }
    
    .stat-item.warning {
        border-left-color: #ffc107;
    }
    
    .stat-item.error {
        border-left-color: #dc3545;
    }
    
    .controls-panel {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .legend {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 10px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
    
    .legend-color.physics {
        background: linear-gradient(135deg, #28a745, #1e7e34);
    }
    
    .legend-color.chemistry {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }
    
    .legend-color.other {
        background: linear-gradient(135deg, #ffc107, #e0a800);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .loading-content {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        text-align: center;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    @media (max-width: 768px) {
        .planning-editor {
            font-size: 0.8em;
        }
        
        .planning-grid th,
        .planning-grid td {
            min-width: 80px;
            padding: 4px;
        }
        
        .course-card {
            min-height: 40px;
            font-size: 0.7em;
        }
        
        .controls-panel {
            padding: 10px;
        }
        
        .stat-item {
            display: block;
            margin-right: 0;
            margin-bottom: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-calendar-alt"></i> √âditeur de Planning Interactive</h2>
                <div>
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="resetPlanning()">
                        <i class="fas fa-undo"></i> R√©initialiser
                    </button>
                    <a href="/admin" class="btn btn-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Retour Admin
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panneau de contr√¥les -->
    <div class="controls-panel">
        <div class="row">
            <div class="col-md-6">
                <h5>Configuration du jour</h5>
                <div class="row">
                    <div class="col-6">
                        <label for="target-date" class="form-label">Date du planning:</label>
                        <input type="date" id="target-date" class="form-control" required>
                    </div>
                    <div class="col-6 d-flex align-items-end">
                        <button type="button" class="btn btn-primary" onclick="loadPlanningData()">
                            <i class="fas fa-cogs"></i> G√©n√©rer et √âditer le Planning
                        </button>
                    </div>
                </div>
                <small class="text-muted">Le planning sera g√©n√©r√© automatiquement par OR-Tools puis affich√© pour √©dition manuelle.</small>
            </div>
            <div class="col-md-6">
                <h5>Actions</h5>
                <button type="button" class="btn btn-success" onclick="generateFinalPlanning()" disabled id="generate-btn">
                    <i class="fas fa-file-excel"></i> G√©n√©rer Planning Excel Final
                </button>
                <div class="legend mt-2">
                    <strong>L√©gende:</strong>
                    <div class="legend-item">
                        <div class="legend-color physics"></div>
                        <span>Physique</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color chemistry"></div>
                        <span>Chimie</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color other"></div>
                        <span>Autre</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panneau de statistiques -->
    <div class="stats-panel" id="stats-panel" style="display: none;">
        <h5>Statistiques du Planning</h5>
        <div id="stats-content">
            <!-- Les statistiques seront charg√©es ici -->
        </div>
    </div>
    
    <!-- Zone d'√©dition du planning par salle -->
    <div class="planning-editor">
        <div class="row" id="rooms-container">
            <!-- Les salles seront g√©n√©r√©es dynamiquement -->
        </div>
    </div>
    
    <!-- Message quand aucun planning n'est charg√© -->
    <div id="no-planning-message" class="text-center py-5">
        <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Aucun planning charg√©</h4>
        <p class="text-muted">S√©lectionnez une date et cliquez sur "G√©n√©rer et √âditer le Planning" pour que OR-Tools optimise automatiquement les assignations de salles.</p>
        <p class="text-muted">Vous pourrez ensuite modifier manuellement le planning avant l'export Excel.</p>
    </div>
</div>

<!-- Overlay de chargement -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status"></div>
        <h5 class="mt-3">Chargement en cours...</h5>
        <p class="text-muted mb-0" id="loading-message">G√©n√©ration du planning initial...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let planningData = null;
    let currentAssignments = {};
    let currentRoomAssignments = {};
    let draggedElement = null;
    let originalPosition = null;
    
    // Initialiser la date par d√©faut (aujourd'hui)
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        document.getElementById('target-date').value = today.toISOString().split('T')[0];
    });
    
    // Charger les donn√©es du planning
    async function loadPlanningData() {
        const targetDate = document.getElementById('target-date').value;
        
        if (!targetDate) {
            showAlert('Veuillez s√©lectionner une date.', 'warning');
            return;
        }
        
        showLoading('G√©n√©ration du planning optimis√© par OR-Tools...');
        
        try {
            console.log('üîÑ Appel API avec date:', targetDate);
            const response = await fetch(`/api/planning-editor/data?date=${targetDate}`);
            console.log('üì° R√©ponse API status:', response.status);
            const data = await response.json();
            console.log('üìã Donn√©es re√ßues:', data);
            
            if (response.ok) {
                planningData = data;
                currentAssignments = { ...data.assignments };
                currentRoomAssignments = { ...data.room_assignments || {} };
                
                // Debug des donn√©es re√ßues
        console.log('üìä DEBUG - Donn√©es re√ßues:', {
            courses: data.courses?.length || 0,
            room_assignments: Object.keys(data.room_assignments || {}).length,
            rooms: data.rooms?.length || 0,
            room_names: data.rooms?.map(r => r.name)
        });
        
        // Debug complet des assignations
        console.log('üîç TOUTES les assignations:', data.room_assignments);
        console.log('üîç TOUS les cours avec temps:', data.courses.map(c => ({id: c.id, teacher: c.teacher, time: c.time, assignedRoom: data.room_assignments[c.id]})));
        
        // APPELER renderPlanningGrid() maintenant avec les donn√©es de test
        console.log('üé® Appel renderPlanningGrid()');
        renderPlanningGrid();
        updateStats();
                document.getElementById('generate-btn').disabled = false;
                showAlert('Planning g√©n√©r√© et pr√™t √† √©diter!', 'success');
            } else {
                throw new Error(data.error || 'Erreur lors de la g√©n√©ration');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert(`Erreur lors de la g√©n√©ration: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // Afficher le planning en grille type Excel
    function renderPlanningGrid() {
        console.log('üé® renderPlanningGrid() appel√©e, planningData:', planningData);
        if (!planningData) {
            console.log('‚ùå Pas de planningData, arr√™t');
            return;
        }
        
        const container = document.getElementById('rooms-container');
        console.log('üì¶ Container trouv√©:', container);
        
        // IMPORTANT: R√©initialiser compl√®tement le container pour √©viter les cours fant√¥mes
        console.log('üßπ Nettoyage du container avant re-rendu');
        container.innerHTML = '';
        container.className = 'table-responsive'; // Ajouter classe responsive pour d√©filement horizontal
        
        const rooms = planningData.rooms;
        const timeSlots = planningData.time_slots;
        
        console.log('üè¢ Salles disponibles:', rooms);
        console.log('‚è∞ Cr√©neaux horaires:', timeSlots);
        
        // Cr√©er la grille principale
        const grid = document.createElement('div');
        grid.className = 'planning-grid';
        console.log('üìã Grille cr√©√©e:', grid);
        
        // En-t√™te avec les noms des salles
        const headerRow = document.createElement('div');
        headerRow.className = 'grid-header';
        
        // Cellule vide pour l'angle
        const cornerCell = document.createElement('div');
        cornerCell.className = 'time-header';
        cornerCell.textContent = 'Horaire';
        headerRow.appendChild(cornerCell);
        
        // En-t√™tes des salles
        rooms.forEach(room => {
            const roomHeaderCell = document.createElement('div');
            roomHeaderCell.className = 'room-header-cell';
            roomHeaderCell.textContent = room.name;
            headerRow.appendChild(roomHeaderCell);
        });
        
        grid.appendChild(headerRow);
        
        // Debug des correspondances IDs
        console.log('üîç Premiers cours (IDs):', planningData.courses.slice(0, 3).map(c => ({id: c.id, teacher: c.teacher, subject: c.subject})));
        console.log('üîç Room assignments (cl√©s):', Object.keys(currentRoomAssignments).slice(0, 5));
        console.log('üîç currentRoomAssignments complet:', currentRoomAssignments);
        console.log('üîç Correspondance ID cours 0:', {
            courseId: planningData.courses[0]?.id,
            assignment: currentRoomAssignments[planningData.courses[0]?.id]
        });
        
        // Compteur de placement des cours
        let totalCoursesPlaced = 0;
        let placementByRoom = {};
        rooms.forEach(room => placementByRoom[room.name] = 0);
        
        // Cr√©er une ligne pour chaque cr√©neau horaire
        timeSlots.forEach(slot => {
            const row = document.createElement('div');
            row.className = 'grid-row';
            
            // Cellule de l'horaire
            const timeCell = document.createElement('div');
            timeCell.className = 'time-cell';
            timeCell.textContent = slot;
            row.appendChild(timeCell);
            
            // Cellule pour chaque salle
            rooms.forEach(room => {
                const roomCell = document.createElement('div');
                roomCell.className = 'room-cell drop-zone';
                roomCell.dataset.room = room.name;
                roomCell.dataset.slot = slot;
                

                
                // Chercher les cours assign√©s √† cette salle et ce cr√©neau
                const coursesInSlot = planningData.courses.filter(course => {
                    const assignedRoom = currentRoomAssignments[course.id];
                    const matchRoom = assignedRoom === room.name;
                    const matchTime = course.time === slot;
                    
                    // Debug pour le premier cr√©neau et premi√®re salle seulement
                    if (room.name === 'C21' && slot === '9h00' && course.id === planningData.courses[0]?.id) {
                        console.log(`üîç Debug match pour ${course.id}:`, {
                            courseId: course.id,
                            assignedRoom: assignedRoom,
                            roomName: room.name,
                            matchRoom: matchRoom,
                            courseTime: course.time,
                            slot: slot,
                            matchTime: matchTime,
                            match: matchRoom && matchTime
                        });
                    }
                    
                    return matchRoom && matchTime;
                });
                
                // Ajouter les cours trouv√©s
                coursesInSlot.forEach(course => {
                    const courseCard = createCourseCard(course);
                    roomCell.appendChild(courseCard);
                    totalCoursesPlaced++;
                    placementByRoom[room.name]++;
                });
                
                // Configurer les √©v√©nements de drop
                setupDropZone(roomCell);
                
                row.appendChild(roomCell);
            });
            
            grid.appendChild(row);
        });
        
        container.appendChild(grid);
        console.log('‚úÖ Grille ajout√©e au container');
        
        // Debug du placement final
        console.log('üìä PLACEMENT FINAL:', {
            totalCoursesPlaced: totalCoursesPlaced,
            placementByRoom: placementByRoom,
            totalCoursesExpected: planningData.courses.length
        });
        
        // Masquer le message "aucun planning"
        const noMsg = document.getElementById('no-planning-message');
        const statsPanel = document.getElementById('stats-panel');
        console.log('üé≠ Masquage du message "aucun planning", √©l√©ments:', noMsg, statsPanel);
        
        if (noMsg) noMsg.style.display = 'none';
        if (statsPanel) statsPanel.style.display = 'block';
        
        console.log('‚úÖ renderPlanningGrid() termin√© avec succ√®s');
    }
    
    // Cr√©er une carte de cours
    function createCourseCard(course) {
        const card = document.createElement('div');
        card.className = `course-card ${getCourseType(course.subject)}`;
        card.draggable = true;
        card.dataset.courseId = course.id;
        
        card.innerHTML = `
            <div class="course-title">${course.subject}</div>
            <div class="course-level">${course.level}</div>
            <div class="course-teacher">${course.teacher}</div>
            <div class="course-time">${course.time}</div>
        `;
        
        // Ajouter les √©v√©nements de drag
        setupDragEvents(card);
        
        return card;
    }
    
    // Obtenir le type de cours pour le style
    function getCourseType(subject) {
        const subjectLower = subject.toLowerCase();
        if (subjectLower.includes('physique') || subjectLower.includes('physics')) {
            return 'physics';
        } else if (subjectLower.includes('chimie') || subjectLower.includes('chemistry')) {
            return 'chemistry';
        } else {
            return 'other';
        }
    }
    
    // Formater l'en-t√™te des jours
    function formatDayHeader(day) {
        const date = new Date(day);
        const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        const dayName = dayNames[date.getDay()];
        const dayNum = date.getDate();
        const month = date.getMonth() + 1;
        return `${dayName} ${dayNum}/${month}`;
    }
    
    // Configurer les √©v√©nements de drag pour les cours
    function setupDragEvents(card) {
        card.addEventListener('dragstart', function(e) {
            draggedElement = this;
            originalPosition = this.parentElement;
            this.classList.add('dragging');
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        });
        
        card.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
            draggedElement = null;
            originalPosition = null;
        });
    }
    
    // Configurer les zones de drop
    function setupDropZone(cell) {
        cell.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        cell.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });
        
        cell.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedElement) {
                const courseId = draggedElement.dataset.courseId; // Ne pas convertir en int !
                const newRoom = this.dataset.room;
                const newSlot = this.dataset.slot;
                
                console.log(`üîÑ D√©placement: ${courseId} vers ${newRoom} √† ${newSlot}`);
                
                // Mettre √† jour l'assignation de salle
                if (newRoom && courseId) {
                    currentRoomAssignments[courseId] = newRoom;
                    
                    // Mettre √† jour le cours dans planningData
                    const course = planningData.courses.find(c => c.id === courseId); // Comparaison stricte
                    if (course) {
                        course.room = newRoom;
                        course.time = newSlot;
                        console.log(`‚úÖ Cours mis √† jour:`, course);
                    } else {
                        console.log(`‚ùå Cours non trouv√©: ${courseId}`);
                    }
                }
                
                // Re-rendre la grille
                renderPlanningGrid();
                updateStats();
                
                showAlert(`Cours d√©plac√© vers ${newRoom} √† ${newSlot}`, 'success');
            }
        });
    }
    
    // Obtenir l'info de position √† partir de la cellule
    function getPositionFromCell(cell) {
        if (!cell || !cell.dataset) return null;
        return {
            room: cell.dataset.room,
            slot: cell.dataset.slot
        };
    }
    
    // Mettre √† jour les statistiques
    function updateStats() {
        if (!planningData) return;
        
        const statsContent = document.getElementById('stats-content');
        const totalCourses = planningData.courses.length;
        
        // Compter les cours assign√©s √† des salles
        const assignedCourses = planningData.courses.filter(c => 
            currentRoomAssignments[c.id] && currentRoomAssignments[c.id] !== 'Non assign√©'
        ).length;
        const unassignedCourses = totalCourses - assignedCourses;
        
        // D√©tecter les conflits (plusieurs cours m√™me salle m√™me heure)
        const conflicts = new Map();
        planningData.courses.forEach(course => {
            const key = `${currentRoomAssignments[course.id]}_${course.time}`;
            if (!conflicts.has(key)) {
                conflicts.set(key, []);
            }
            conflicts.get(key).push(course.id);
        });
        
        const conflictCount = Array.from(conflicts.values()).filter(courses => courses.length > 1).length;
        
        // Compter les salles utilis√©es
        const usedRooms = new Set(Object.values(currentRoomAssignments).filter(room => room !== 'Non assign√©')).size;
        
        statsContent.innerHTML = `
            <div class="stat-item">
                <strong>Cours total:</strong> ${totalCourses}
            </div>
            <div class="stat-item">
                <strong>Cours assign√©s:</strong> ${assignedCourses}
            </div>
            <div class="stat-item ${unassignedCourses > 0 ? 'warning' : ''}">
                <strong>Non assign√©s:</strong> ${unassignedCourses}
            </div>
            <div class="stat-item ${conflictCount > 0 ? 'error' : ''}">
                <strong>Conflits salle/heure:</strong> ${conflictCount}
            </div>
            <div class="stat-item">
                <strong>Salles utilis√©es:</strong> ${usedRooms}/${planningData.rooms.length}
            </div>
        `;
    }
    
    // R√©initialiser le planning
    function resetPlanning() {
        if (planningData && confirm('√ätes-vous s√ªr de vouloir r√©initialiser le planning aux assignations automatiques ?')) {
            currentAssignments = { ...planningData.assignments };
            renderPlanningGrid();
            updateStats();
            showAlert('Planning r√©initialis√©!', 'info');
        }
    }
    
    // G√©n√©rer le planning Excel final
    async function generateFinalPlanning() {
        if (!planningData) {
            showAlert('Aucun planning charg√©.', 'warning');
            return;
        }
        
        const targetDate = document.getElementById('target-date').value;
        
        showLoading('G√©n√©ration du fichier Excel...');
        
        try {
            // Cr√©er les assignments bas√©s sur les positions actuelles des cours
            const finalAssignments = {};
            planningData.courses.forEach(course => {
                const slotKey = `${planningData.days[0]}_${course.time}`;
                if (!finalAssignments[slotKey]) {
                    finalAssignments[slotKey] = [];
                }
                finalAssignments[slotKey].push(course.id);
            });
            
            const response = await fetch('/api/planning-editor/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    assignments: finalAssignments,
                    room_assignments: currentRoomAssignments,
                    date: targetDate
                })
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `planning_personnalise_${targetDate}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('Planning Excel g√©n√©r√© avec succ√®s!', 'success');
            } else {
                const data = await response.json();
                throw new Error(data.error || 'Erreur lors de la g√©n√©ration');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert(`Erreur lors de la g√©n√©ration: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // Afficher l'overlay de chargement
    function showLoading(message = 'Chargement...') {
        document.getElementById('loading-message').textContent = message;
        document.getElementById('loading-overlay').style.display = 'flex';
    }
    
    // Masquer l'overlay de chargement
    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }
    
    // Afficher une alerte
    function showAlert(message, type = 'info') {
        // Cr√©er une alerte Bootstrap
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Ins√©rer au d√©but du container
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alert, container.firstChild);
        
        // Auto-supprimer apr√®s 5 secondes
        setTimeout(() => {
            if (alert && alert.parentElement) {
                alert.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}